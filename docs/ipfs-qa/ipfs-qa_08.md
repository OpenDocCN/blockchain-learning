# 第八章 【IPFS 一问一答】IPFS 的技术背景技术之 BitTorrent 协议是怎么工作的？

# 8 IPFS 的技术背景技术之 BitTorrent 协议是怎么工作的？

BitTorrent（简称 BT）是一个文件分发协议，即每个下载者在下载的同时会向其他下载者提供已下载的数据。在传统的 FTP、HTTP 协议中，所有的下载者都向中心服务器请求数据，各个下载者之间没有任何交互。这会出现一个问题，当非常多的下载者同时下载同一个数据时，由于中心服务器的处理能力和带宽限制，导致下载数据非常之慢，甚至有些用户都连不上服务器。BT 下载则完全不同，由于其下载文件共享下载的特性，使得下载者越多下载速度越快。

### 8.1 BitTorrent 的构成

基于 BitTorrent 协议的文件分发系统由以下部分组成： （1）Web 服务器。 （2）种子文件。 （3）Tracker 服务器。 （4）原始文件提供者。 （5）网络浏览器。 （6）下载者。

Web 服务器上保存着种子文件，下载者需要首先从 web 服务器上下载种子文件。种子文件又叫元文件（metafile），它保存了共享文件的信息，如文件名、文件大小、Tracker 服务器的地址等。种子文件非常小，一般大小为 1GB 的共享文件，其种子文件不足 100KB，种子文件以.torrent 为后缀。种子文件中的 Tracker 服务器地址是记录下载该文件的所有节点的 IP 和端口。种子文件是由原始文件提供者制作的。制作过程：首先下载 BT 客户端，然后新建一个 BT 种子任务，选中要共享的文件，再点击制作即可完成种子文件的制作。用户将种子文件上传到网络中，其他用户就可以通过该种子文件获取到对应的文件内容。

用户使用种子文件下载的过程：用户首先下载 BT 种子文件，然后在迅雷（或其他下载客户端）客户端中新建一个 BT 任务，选中种子文件，点击开始下载即可。原理是这样的，客户端首先解析种子文件，获取待下载的共享文件的一些信息，其中包括 Tracker 服务器的地址。然后客户端连接 Tracker 获取当前下载该文件的所有下载者的 IP 和端口。之后客户端根据 IP 和端口连接其他下载者，从它们那里下载文件，同时把自己已下载的部分提供给其他下载者下载。

共享文件在逻辑上被划分为大小相同的块，称为 piece，每个 piece 的大小通常为 256KB。对于共享文件，文件的第 1 字节到第 256K（即 262144）字节为第一个 piece，第 256K＋1 字节到第 512K 字节为第二个 piece，依此类推。种子文件中包含有每个 piece 的 hash 值。BT 协议规定使用 Sha1 算法对每个 piece 生成 20 字节的 hash 值，作为每个 piece 的指纹。每当客户端下载完一个 piece 时，即对该 peice 使用 Sha1 算法计算其 hash 值，并与种子文件中保存的该 peice 的 hash 值进行比较，如果一致即表明下载了一个完整而正确的 piece。一旦某个 piece 被下载，该 piece 即提供给其他 peer 下载。在实际上传和下载中，每个 piece 又被划分为大小相同的 slice，每个 slice 的大小固定为 16KB（16384 字节）。peer 之间每次传输以 slice 为单位。

从以上描述可以得知，待开发的 BT 软件（即 BT 客户端）主要包含以下几个功能：解析种子文件获取待下载的文件的一些信息，连接 Tracker 获取 peer 的 IP 和端口，连接 peer 进行数据上传和下载、对要发布的提供共享文件制作和生成种子文件。种子文件和 Tracker 的返回信息都以一种简单而高效的编码方式进行编码，称为 B 编码。客户端与 Tracker 交换信息基于 HTTP 协议，Tracker 本身作为一个 Web 服务器存在。客户端与其他 peer 采用面向连接的可靠传输协议 TCP 进行通信

### 8.2 B 编码

种子文件和 Tracker 返回的信息都是经过 B 编码的。要解析和处理种子文件以及 Tracker 的返回信息，首先要熟悉 B 编码的规则。B 编码共有 4 种类型：

1.  整型：编码格式是 i<十进制数字>e。比如十进制整数 8，经过 B 编码后为 i8e；-6 经过编码后是 i-6e。
2.  字符串型：编码格式是<字符串的长度>:<字符串>。如字符串 hello 经过 B 编码后为 5:hello。
3.  列表型：编码格式是 l<任意类型 B 编码的组合>e。l 是 list 的第一个字母。如两个字符串列表，字符串分别是 chain，block，经过 B 编码后是 l5:chain5:blocke；一个整型一个字符串的列表，整数 3 和字符串 hi，经过 B 编码后是 li3e2:hie
4.  字典型：编码格式是 d<关键字><值>e，d 是 dictionary 的第一个字母，关键字是一个经过 B 编码的字符串，值可以是任何合法的 B 编码类型，在 d 和 e 之间可以出现多个关键字和值对。例如，d4:spaml3:aaa3:bbbee，它是一个字典，该字典的关键字是 spam，值是一个列表（以 l 开始，以 e 结束），列表中有两个字符串 aaa 和 bbb。

### 8.3 种子文件的结构

种子文件的关键字如下表：

| 名----------字 | 类--------------型 | 意---义 |
| --- | --- | --- |
| announce | string | TrackerServer 的地址 |
| announce-list | List of list | TrackerServer 分组列表 |
| info | Dict（k/v 集合） | 该关键字对应的值是一个字典，该关键字对应的值是一个字典，它有两种模式，“singel file”和“multiple file”，文件模式和多文件模式。单文件模式是指待共享的文件只有一个，多文件模式是指提供共享的不止一个文件，而是两个或两个以上。如使用 BT 软件下载一部影片时，影片的上下部可能分别放在不同的文件里 |
| publisher | string | 种子发布者名称 |
| publisher-url | string | 种子发布者 URL |
| nodes | list | DHT（分布式哈希表）的节点列表 |
| encoding | string | 种子文件的字符编码，如 UTF-8 |

其中种子文件中最重要的关键字是 info，无论是单文件模式还是多文件模式，该字典都包含关键字如下表所示。

| ---关键字---- | 含 义 |
| --- | --- |
| piece length | 每个 piece 的长度，它的值是一个 B 编码的整型，该值通常为 i262144e，即 256K，也有可能为 512K 或 128K |
| pieces | 对应的值为一个字符串，它存放的是各个 piece 的 hash 值，这个字符串的长度一定是 20 的倍数，因为每个 piece 的 hash 值的长度为 20 字节 |
| private | 该值如果为 1，则表明客户端必须通过连接 Tracker 来获取其他下载者，即 peer 的 IP 地址和端口号；如果为 0，则表明客户端还可以通过其他方式来获取 peer 的 IP 地址和端口号，如 DHT 方式。DHT 即分布式哈希表（Distribute Hash Tabel），它是一种以分布式的方式来获取 peer 的方法，现在许多 BT 客户端既支持通过连接 Tracker 来获取 peer，也支持通过 DHT 来获取 peer。如果种子文件中没有 private 这个关键字，则表明不限制一定要通过连接 Tracker 来获取 peer |

对于单文件模式的种子文件，info 的值还含有的关键字如下表所示。

| --关键字-- | 含 义 |
| --- | --- |
| name | 共享文件的文件名，也就是要下载的文件的文件名 |
| length | 共享文件的长度，以字节为单位 |
| md5sum | 可选，它是共享文件的 md5 值，这个值在 BT 协议中根本没有使用，所以不必理会 |

对于多文件模式的种子文件，info 的值还含有的关键字如下表所示

| 关键字 | 含义 |
| --- | --- |
| name | 存放所有共享文件的文件夹名 |
| files | 它的值是一个列表，列表中含有多个字典，每个共享文件为一个字典。该字典中含有三个关键词 |

Files 的每个共享文件为一个字典字典的关键词如下表所示

| 关 键 词 | 含 义 |
| --- | --- |
| length | 共享文件的长度，以字节为单位 |
| md5sum | 可选，同上 |
| path | 存放的是共享文件的路径和文件名 |

### 8.4 与 Tracker 交互

完成解析种子文件并从中获取 Tracker 服务器的 URL 后，即可开始与 Tracker 进行交互。与 Tracker 进行交互主要有两个目的：一是将自己的下载进度告知给 Tracker 以便 Tracker 进行一些相关的统计；二是获取当前下载同一个共享文件的 peer 的 IP 地址和端口号。 客户端使用 HTTP 协议与 Tracker 进行通信。Tracker 通过 HTTP GET 方法获取请求，请求的构成为 Tracker 的 URL 后面跟一个？以及参数和值对，如 http://tk.greedland.net/ announce? param1= value1&param2= value2。 在客户端发往 Tracker 的 GET 请求中，通常包含参数下表所示。

| ---参数--- | 含 义 |
| --- | --- |
| info_hash | 与种子文件中 info 关键字对应的值，通过 Sha1 算法计算其 hash 值，该 hash 值就是 info_hash 参数对应的值，该 hash 值的长度固定为 20 字节 |
| peer_id | 每个客户端在下载文件前以随机的方式生成的 20 字节的标识符，用于标识自己，它的长度也是固定不变的 |
| port | 监听端口号，用于接收其他 peer 的连接请求 |
| uploaded | 当前总的上传量，以字节为单位 |
| downloaded | 当前总的下载量，以字节为单位 |
| left | 还剩余多少字节需要下载，以字节为单位 |
| compact | 该参数的值一般为 1 |
| event | 它的值为 started、completed、stopped 其中之一。客户端第一次与 Tracker 进行通信时，该值为 started；下载完成时，该值为 completed；客户端即将关闭时，该值为 stopped |
| ip | 可选，将客户端的 IP 地址告知给 Tracker，Tracker 可以通过分析客户端发给 Tracker 的 IP 数据包来获取客户端的 IP 地址，因此该参数是可选的，一般不用指明客户端的 IP |
| numwant | 可选，希望 Tracker 返回多少个 peer 的 IP 地址和端口号。如果该参数缺省，则默认返回 50 个 peer 的 IP 地址和端口号 |
| key | 可选，它的值为一个随机数，用于进一步标识客户端。因为已经由 peer_id 来标识客户端，因此该参数一般不使用 |
| trackerid | 可选，一般不使用 |

Tracker 服务器的返回信息是一个经过 B 编码的字典。它含有关键字如下表所示。

| ----关键字---- | 含 义 |
| --- | --- |
| failure reason | 该关键字对应的值是一个可以读懂的字符串，指明 GET 请求失败的原因，如果返回信息中含有这个关键字，就不会再包含其他任何关键字 |
| warnging message | 该关键字对应的值是一个可以读懂的警告字符串 |
| interval | 指明客户端在下一次连接 Tracker 前所需等待的时间，以秒为单位 |
| min interval | 指明客户端在下一次连接 Tracker 前所需等待的最少时间，以秒为单位 |
| tracker id | 指明 Tracker 的 ID |
| complete | 一个整数，指明当前有多少个 peer 已经完成了整个共享文件的下载 |
| incomplete | 一个整数，指明当前有多少个 peer 还没有完成共享文件的下载 |
| peers | 返回各个 peer 的 IP 和端口号，它的值是一个字符串。首先是第一个 peer 的 IP 地址，然后是其端口号；接着是第二个 peer 的 IP 地址，然后是其端口号；依此类推 |

以下是一个发往 Tracker 服务器的 HTTP GET 请求的示例： [`tk.greedland.net/announce?info_hash=01234567890123456789`](http://tk.greedland.net/announce?info_hash=01234567890123456789)& peer_id=01234567890123456789&port=3210&compact=1&uploaded=0&downloaded=0&left=8000000&event=started 以下是一个 Tracker 服务器回应的示例： d8:completei100e10:incompletei200e8:intervali1800e5:peers300:......e 其中，“......”是一个长度为 300 的字符串，含有 50 个 peer 的 IP 地址和端口号。IP 地址占 4 字节，端口号占 2 字节，即一个 peer 占 6 字节。

### 8.5 peer 之间的通信协议

peer 之间的通信协议又称为 peer wire protocal，即 peer 连线协议，它是一个基于 TCP 协议的应用层协议。 为了防止有的 peer 只下载不上传，BitTorrent 协议建议，客户端只给那些向它提供最快下载速度的 4 个 peer 上传数据。简单地说就是谁向我提供下载，我也提供数据供它下载；谁不提供数据给我下载，我的数据也不会上传给它。客户端每隔一定时间，比如 10 秒，重新计算从各个 peer 处下载数据的速度，将下载速度最快的 4 个 peer 解除阻塞，允许这 4 个 peer 从客户端下载数据，同时将其他 peer 阻塞。 一个例外情况是，为了发现下载速度更快的 peer，协议还建议，在任一时刻，客户端保持一个优化非阻塞 peer，即无论该 peer 是否提供数据给客户端下载，客户端都允许该 peer 从客户端这里下载数据。由于客户端向 peer 上传数据，peer 接着也允许客户端从 peer 处下载数据，并且下载速度超过 4 个非阻塞 peer 中的一个。客户端每隔一定的时间，如 30 秒，重新选择优化非阻塞 peer。 当客户端与 peer 建立 TCP 连接后，客户端必须维持的几个状态变量如下表所示。

| ----状态变量---- | 含 义 |
| --- | --- |
| am_chocking | 该值若为 1，表明客户端将远程 peer 阻塞。此时如果 peer 发送数据请求给客户端，客户端将不会理会。也就是说，一旦将 peer 阻塞，peer 就无法从客户端下载到数据；该值若为 0，则刚好相反，即表明 peer 未被阻塞，允许 peer 从客户端下载数据 |
| am_interested | 该值若为 1，表明客户端对远程的 peer 感兴趣。当 peer 拥有某个 piece，而客户端没有，则客户端对 peer 感兴趣。该值若为 0，则刚好相反，即表明客户端对 peer 不感兴趣，peer 拥有的所有 piece，客户端都拥有 |
| peer_chocking | 该值若为 1，表明 peer 将客户端阻塞。此时，客户端无法从 peer 处下载到数据。该值若为 0，表明客户端可以向 peer 发送数据请求，客户端将进行响应 |
| peer_interested | 该值若为 1，表明 peer 对客户端感兴趣。也即客户端拥有某个 piece，而 peer 没有。该值若为 0，表明 peer 对客户端不感兴趣 |

当客户端与 peer 建立 TCP 连接后，客户端将这几个变量的值设置为。 am_chocking = 1。 am_interested = 0。 peer_chocking = 1。 peer_interested = 0。 当客户端对 peer 感兴趣且 peer 未将客户端阻塞时，客户端可以从 peer 处下载数据。当 peer 对客户端感兴趣，且客户端未将 peer 阻塞时，客户端向 peer 上传数据。 除非另有说明，所有的整数型在本协议中被编码为 4 字节值（高位在前低位在后），包括在握手之后所有信息的长度前缀。

### 8.6 BT 下载实现的关键算法和策略

#### 8.6.1 流水线作业

网络协议一般都要求具有较高的传输效率，BT 协议就是采用了流水线作业来提供传输效率的。 当客户端向 peer 发送数据请求时(即发送 request 消息),一次请求多个 slice（即一个数据包发送多个 request 消息请 求多个 slice）。假如客户端一次只发送一个 slice 请求，则 peer 给客户端发送完一个 slice 的数据后进入等待，等待客户 端发送新的数据请求。如果一次发送多个 slice 请求，则 peer 发送完一个 slice 后接着发送下一个 slice，从而避免了等待 提高数据传输的效率。 HTTP 协议的 1.1 版本就广泛地采用流水线作业的思想，大大提高了浏览器和 Web 服务器之间的传输效率。

#### 8.6.2 片断选择算法

片段选择有四大策略，良好的策略对于提高下载速度至关重要。

一、一旦向某个 peer 发送对某个 piece 中的 slice 的请求后，则该 piece 中的其他 slice 也从该 peer 处下载，这样可以 尽快地下载到一个完整的 piece。因为某个 peer 拥有某个 piece 中的一个 slice，则它必定拥有该 piece 的其他 slice，并且 如果 peer 愿意发送一个 slice 给客户端，它也应该愿意发送 piece 中的其他 slice 给客户端。

二、最少优先。即某个 piece 在所有 peer 中拥有率最低，则优先下载该 piece。此做法可以防止拥有此 piece 的 peer 突然离开，导致某个 piece 的缺失，从而当前如何一个参与下载的 peer 都不能下载到一个完整的文件；如果下载了 某些拥有率较低的 piece，则其他很多 peer 会向客户端请求数据，而要想从客户端下载到数据，那些 peer 就要提供数据 给客户端下载，这样对于提高客户端的下载速度也是有帮助的。对于这个共享系统而言，优先下载拥有率低的 piece 可以使得整个系统提高每个 piece 的拥有读，整个系统会趋向与最优。如果所有 peer 优先下载拥有率较高的 piece，则 piece 拥有率更低，可能会导致很多 peer 得不到完整的文件。

三、随机选择第一个要下载的 piece。开始下载时，不能采用最少优先策略。因为如果 piece 的拥有率很低，则 下载到这个 piece 就相对较难。如果随即选择一个 piece，那么更容易下载到该 piece，一旦客户端下载到一个完整 piece，就可以提供给其他 peer 下载，而由于客户端向其他 peer 上传数据，会倒在其他 peer 对客户端解除阻塞，从而 有利于在起始阶段获得较高的下载速度。当在下载到一些 piece 后，客户端 应采用最少优先策略来下载数据，这虽然 会导致客户端的下载速度在短期内有所下降，但随后下载速度会有较大提高。

四、最后阶段模式。有时，从一个传输速度很慢的 peer 处下载一个 piece 会花费很长时间，在下载的过程中不是 什么大问题，但在下载接近完成时，如果发生这种情况，会导致客户端迟迟不能下载完成。为了解决这个问题，在 最后阶段，客户端向所有 peer 发送对这个 piece 的某些 slice 请求，一旦收到某个 peer 发来的 slice，则向其他 peer 发 送 cancel 消息，只从当前这个 peer 处下载。

#### 8.6.3 阻塞算法

BT 并不集中分配资源，每个 peer 有责任尽可能地提高自己的下载速度。peer 从它可以连接的 peer 下载文件，并根据对方提供的下载速率给予同等的上传回报，对于合作者，提供上传服务，对于不合作的，就阻塞对方。阻塞是一种临时拒绝上传的策略，虽然上传停止了，但是下载仍然继续。在解除阻塞时，连接并不需要重新建立。因为阻塞过程中只是拒绝传输 piece 消息，其他消息，如 have 消息，interested 消息仍可以传输。阻塞算法虽然不是 BT 协议一部分，但是它对提高性能是必要的。

每个客户端一直与固定数量的 peer 保持疏通（通常是 4 个），那么以什么方式来决定是否保持与某个 peer 疏通呢？通常的做法是，严格地根据当前的下载速度来决定哪些 peer 应该保持疏通。但计算当前下载速度是个大难题。当前的实现通常是计算最近 10 秒从每个 peer 处下载数据的速度。以 10 秒为间隔重新选择保持疏通（即解除阻塞）的 peer，是为了避免频繁地阻塞和解阻塞，造成资源的浪费。实践表明，10 秒足以使下载速度达到最大。

如果只是简单地为提供最高下载速率的 4 个 peer 提供上载服务，那么就没有办法发现那些空闲的连接是否有更好的下载速度。为了解决这个问题，在任何时候，每个 peer 都拥有一个称为“optimistic unchoking（优化非阻塞）”peer，这个连接总是保持疏通状态，而不管它的下载速率是多少。每隔 30 秒，重新选择一个 peer 作为优化非阻塞 peer。30 秒足以让该 peer 的上载能力达到最大。

一旦某个 peer 完成了下载，它不能再通过下载速率（因为下载速率已经为 0 了）来决定为哪些 peer 提供上载了。目前采用的解决办法是，优先选择那些从它这里得到更好下载速率的 peer，保持与它们疏通。这样做的理由是尽可能的利用上载带宽。一旦某个 peer 完成了下载，那么它也就成为了种子。种子拥有一份完整的文件拷贝，并提供给其他 peer 下载。为了整个系统的性能，每个 peer 在完成下载后应该作为种子存在一段时间，作为对整个系统的回报。原始种子，即最初提供文件进行共享、并制作生成了种子文件，并把种子文件发布到 Web 服务器的种子，它至少应该存在到系统中生成另外一个种子时才能离开，否则当前参与下载的所有 peer 都不能获得一份完整的文件拷贝。