# ç¬¬åä¸‰ç«  äº¤æ˜“æ± è§£æ

æœ¬ç« èŠ‚ä¸»è¦å‘å¤§å®¶ä»‹ç»äº¤æ˜“æ± çš„è¿è½¬åŸç†åŠæµç¨‹ã€å‰–æ Ethereum å’Œ LightEthereum å®¢æˆ·ç«¯äº¤æ˜“æ± çš„å…·ä½“å®ç°ä»¥åŠå¯¹æ¯”ä¸¤è€…åŒºåˆ«ã€‚

* * *

äº¤æ˜“æ± ï¼Œä¸»è¦ç”¨äºæ¥æ”¶äº¤æ˜“ä»¥åŠå¯¹äº¤æ˜“è¢«æ‰“åŒ…ä¹‹å‰è¿›è¡Œå‚æ•°åŠä¸šåŠ¡åˆæ³•æ€§æ ¡éªŒï¼Œæ¯”å¦‚ï¼šäº¤æ˜“æ‰€éœ€ gasã€gasprice å¤ªä½ï¼Œnonce å€¼å¤ªä½æˆ–å¤ªé«˜ç­‰ï¼Œé€šè¿‡æ ¡éªŒä¸€æ–¹é¢å¯ä»¥å°†ä¸åˆæ³•äº¤æ˜“å¿«é€Ÿå¤±è´¥ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¯ä»¥å°†äº¤æ˜“è¿›è¡Œæ‹†åˆ†ï¼Œæé«˜åŒºå—æ‰“åŒ…æ•ˆç‡ã€‚

å…¶ä¸­äº¤æ˜“æ± çš„æ•°æ®æ¥æºä¸»è¦æ¥è‡ªï¼š

*   æœ¬åœ°æäº¤ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨é€šè¿‡è°ƒç”¨æœ¬åœ°ä»¥å¤ªåŠèŠ‚ç‚¹çš„ RPC æœåŠ¡æ‰€æäº¤çš„äº¤æ˜“ï¼›
*   è¿œç¨‹åŒæ­¥ï¼Œæ˜¯æŒ‡é€šè¿‡å¹¿æ’­åŒæ­¥çš„å½¢å¼ï¼Œå°†å…¶ä»–ä»¥å¤ªåŠèŠ‚ç‚¹çš„åŒºå—æˆ–äº¤æ˜“æ•°æ®åŒæ­¥è‡³æœ¬åœ°èŠ‚ç‚¹ã€‚

å¦å¤–ï¼Œåœ¨ä»¥å¤ªåŠçš„æ¶æ„è®¾è®¡ä¸­ï¼Œå…¶å®æ˜¯å­˜åœ¨ä¸¤ç§äº¤æ˜“æ± çš„è®¾è®¡ä¸å®ç°ï¼Œåˆ†åˆ«é’ˆå¯¹ Ethereum å’Œ LightEthereum ä¸¤ç§å®¢æˆ·ç«¯çš„ä¸åŒä¸šåŠ¡åœºæ™¯ã€‚

## æ•°æ®ç»“æ„åˆ†æ

**Transcation**

| å­—æ®µå | å­—æ®µç±»å‹ | è¯´æ˜ |
| --- | --- | --- |
| config | TxPoolConfig | äº¤æ˜“æ± é…ç½®ã€‚æ¯”å¦‚ï¼šæœ€å° gaspriceã€æ¯ä¸ªå¸æˆ·å¯æ‰§è¡Œ |
| chainConfig | *params.ChainConfig | Chain é…ç½®ã€‚æ¯”å¦‚: å…±è¯†é…ç½®ã€DAO åˆ†å‰é«˜åº¦ã€Byzantium åŒºå—é«˜åº¦ |
| chain | blockChain | é’ˆå¯¹å®¢æˆ·ç«¯ä¸åŒï¼Œæœ‰äºŒç§å®ç°: blockchainã€lightchain |
| gasPrice | *big.Int | gas å•ä»· |
| txFeed | event.Feed |  |
| scope | event.SubscriptionScope |  |
| chainHeadCh | chan ChainHeadEvent | è®¾å®šé€šé“å¤§å°ï¼Œæ¥æ”¶é“¾ä¸Šæ–°åŒºå—æ¶ˆæ¯ã€‚ |
| chainHeadSub | event.Subscription |  |
| signer | types.Signer | ç­¾åå¯¹è±¡ |
| mu | sync.RWMutex | é” |
| currentState | *state.StateDB |  |
| pendingState | *state.ManagedState | pending ä¸­äº¤æ˜“çŠ¶æ€ |
| currentMaxGas | uint64 | å½“å‰æœ€å¤§ gasLimit |
| locals | *accountSet | æœ¬åœ°å¸æˆ·é›†åˆ |
| journal | *txJournal | æ—¥å¿—è®°å½• |
| pending | mapcommon.Address*txList | å¯æ‰§è¡Œäº¤æ˜“åˆ—è¡¨ |
| queue | mapcommon.Address*txList | æš‚ä¸å¯æ‰§è¡Œäº¤æ˜“åˆ—è¡¨ |
| beats | mapcommon.Addresstime.Time | å¸æˆ·æœ€åå¿ƒè·³æ—¶é—´ |
| all | *txLookup | æ‰€æœ‰å¯æŸ¥è¯¢çš„äº¤æ˜“åˆ—è¡¨ |
| priced | *txPricedList | åŸºäº gasprice æ’åºç”±é«˜åˆ°ä½çš„äº¤æ˜“åˆ—è¡¨ |
| wg | sync.WaitGroup | homestead | bool | æ˜¯å¦ homestead ç‰ˆæœ¬ |

æˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»ä¸¤ä¸ªå­—æ®µ`pending`ã€`queue`ï¼Œä»å­—æ®µè¯´æ˜å¯ä»¥çŸ¥é“è¿™ä¸¤ä¸ªå­—æ®µä¸»è¦æ˜¯ä»¥åˆ—è¡¨çš„å½¢å¼å­˜å‚¨å¯æ‰§è¡Œä¸éä¸å¯æ‰§è¡Œäº¤æ˜“æ•°æ®ã€‚

ä¹‹æ‰€ä»¥ä½¿ç”¨åˆ—è¡¨ï¼Œä¸»è¦æ˜¯å› ä¸ºåœ¨åŒºå—é“¾ç³»ç»Ÿä¸­ç¡®ä¿ä¸€æ¡äº¤æ˜“æ•°æ®æˆåŠŸï¼Œå¹¶ä¸åƒä¼ ç»Ÿäº’è”ç½‘ç³»ç»Ÿæ¶æ„å¯ä»¥é€šè¿‡äº‹åŠ¡çš„æœºåˆ¶ç«‹å³è·å–æˆåŠŸçŠ¶æ€ï¼Œè€Œæ˜¯éœ€è¦å…¨ç½‘ä¸€å®šèŠ‚ç‚¹çš„ç¡®è®¤æ•°æ‰èƒ½ä¿è¯è¿™æ¡äº¤æ˜“å¤§æ¦‚ç‡ä¸Šæ˜¯æˆåŠŸçš„ï¼Œæ‰€ä»¥å¯¼è‡´è¿™ä¸ªè¿‡ç¨‹éœ€è¦ä¸€å®šçš„æ—¶é—´å‘¨æœŸã€‚

æ­£æ˜¯å› ä¸ºè¿™ä¸ªé—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†æé«˜äº¤æ˜“çš„å¤„ç†æ•ˆç‡åŠç”¨æˆ·ä½¿ç”¨ä½“éªŒï¼Œä¿è¯ä¸€ä¸ªäº¤æ˜“å¯èƒ½å¹¶æœªæˆåŠŸçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç»§ç»­æ¥æ”¶æ–°çš„äº¤æ˜“ï¼Œæ‰€ä»¥ä½¿ç”¨åˆ—è¡¨æ•°æ®ç»“æ„æ¥å­˜å‚¨æ–°äº¤æ˜“æ•°æ®ï¼Œå…¶å®ç±»ä¼¼äºå¸¸è§„æ¶æ„ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶ã€‚

å…¶ä¸­ï¼Œ`pending`å­—æ®µä¸»è¦ç”¨äºå­˜å‚¨ç”¨æˆ·å½“ä¸‹å¯æ‰§è¡Œçš„äº¤æ˜“åˆ—è¡¨æ•°æ®ï¼›`queue`å­—æ®µä¸»è¦ç”¨äºå­˜å‚¨ç”¨æˆ·æš‚ä¸å¯æ‰§è¡Œçš„äº¤æ˜“åˆ—è¡¨æ•°æ®ã€‚

**é‚£ä¹ˆï¼Œå¦‚ä½•ç†è§£å¯æ‰§è¡Œä¸ä¸å¯æ‰§è¡Œå‘¢ï¼Ÿ**
å¯æ‰§è¡Œï¼Œå¯ç®€å•ç†è§£ä¸ºçº¿ç¨‹çš„å°±ç»ªçŠ¶æ€ï¼Œå½“è·å–åˆ° Cpu ä½¿ç”¨æƒåç«‹å³æ‰§è¡Œï¼›éå¯æ‰§è¡ŒåŠ›ï¼Œç†è§£ä¸ºçº¿ç¨‹çš„é˜»å¡çŠ¶æ€ï¼Œæ¯”å¦‚ï¼šNonce å¤ªå¤§ï¼Œåªæœ‰ç­‰å°äºè¿‡å¤§ Nonce-1 çš„äº¤æ˜“æ‰§è¡Œå®Œæˆåï¼Œæ‰ä¼šå°†è¯¥äº¤æ˜“è½¬ç§»è‡³`pending`åˆ—è¡¨æ‰§è¡Œã€‚

* * *

**æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­ä»‹ç»åœ¨å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼Œäº¤æ˜“æ± æ˜¯å¦‚ä½•è¿›è¡Œåˆå§‹åŒ–çš„**

![](img/98239f6ec35f4642a81250ed971439c9.jpg)

äº¤æ˜“æ± çš„æ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹ï¼Œæ˜¯åœ¨ä»¥å¤ªåŠå®¢æˆ·ç«¯(Ethereum/LightEthereum)çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¢«è°ƒç”¨æ‰§è¡Œçš„ï¼ŒNewTxPool æ–¹æ³•ä¾¿æ˜¯åˆå§‹åŒ–äº¤æ˜“æ± å…¥å£ã€‚

```go
eth.txPool = core.NewTxPool(config.TxPool, eth.chainConfig, eth.blockchain) 
```

1.  å¯¹å¯åŠ¨å‚æ•°è¿›è¡Œå‚æ•°æ ¡éªŒåŠé»˜è®¤å‚æ•°é…ç½®ï¼›

    ```go
    config = (&config).sanitize() 
    ```

    `sanitize`æ–¹æ³•ä¸»è¦å¯¹`TxPoolConfig`ä¸­çš„ Rejournalã€PriceLimitã€PriceBump ä¸‰ä¸ªå­—æ®µè¿›è¡Œæ ¡éªŒï¼Œæœªé€šè¿‡æ ¡éªŒåˆ™ä½¿ç”¨ç³»ç»Ÿç¼ºçœå‚æ•°è¿›è¡Œé‡æ–°è®¾å®šã€‚

2.  ä½¿ç”¨å¯åŠ¨å‚æ•°å¯¹ TxPool è¿›è¡Œå¯¹è±¡å®ä¾‹åŒ–ï¼Œä¸»è¦æ˜¯å¯¹ä¸€äº›é›†åˆå˜é‡å’Œæ¶ˆæ¯é€šé“è¿›è¡Œåˆå§‹åŒ–ï¼Œæ¯”å¦‚: pendingã€queueã€beats åˆ—è¡¨é›†åˆã€chainHeadEvent é€šé“ã€‚

3.  åŠ è½½æœ¬åœ°å¸æˆ·ã€‚æˆ‘ä»¬åœ¨å®‰è£…ä»¥å¤ªåŠå®¢æˆ·ç«¯å¾€å¾€å¯ä»¥æŒ‡å®šä¸€ä¸ªæ•°æ®å­˜å‚¨ç›®å½•ï¼Œæ­¤ç›®å½•ä¾¿ä¼šå­˜å‚¨ç€æ‰€æœ‰æˆ‘ä»¬å¯¼å…¥çš„æˆ–è€…é€šè¿‡æœ¬åœ°å®¢æˆ·ç«¯åˆ›å»ºçš„å¸æˆ· keystore æ–‡ä»¶ã€‚è€Œè¿™ä¸ªåŠ è½½è¿‡ç¨‹ä¾¿æ˜¯ä»è¯¥ç›®å½•åŠ è½½å¸æˆ·æ•°æ®ã€‚

    ```go
     pool.locals = newAccountSet(pool.signer)
     for _, addr := range config.Locals {
         log.Info("Setting new local account", "address", addr)
         pool.locals.add(addr)
     } 
    ```

4.  åˆå§‹åŒ– TxPriceList äº¤æ˜“é›†åˆã€‚`TxPricedList`é›†åˆä¸»è¦ç”¨äºå°†äº¤æ˜“æ•°æ®æŒ‰ç…§ GasPriceã€Nonce çš„ä¸šåŠ¡è§„åˆ™è¿›è¡Œæ’åºå¤„ç†ã€‚

    ```go
     pool.priced = newTxPricedList(pool.all) 
    ```

    ä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿ
    å› ä¸º GasPrice è¶Šé«˜çš„äº¤æ˜“ç¡®è®¤é€Ÿåº¦è¶Šå¿«ï¼Œæ‰€ä»¥é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥æ–¹ä¾¿è·å–ä¼˜å…ˆå¤„ç†çš„äº¤æ˜“æ•°æ®ã€‚

5.  åŠ è½½äº¤æ˜“æ± æ•°æ®ã€‚å¦‚æœä¹‹å‰å®¢æˆ·ç«¯å·²å·²è¿è¡Œä¸€æ®µæ—¶é—´ï¼Œé‚£ä¹ˆå°±éœ€è¦ä»æœ¬åœ°ç£ç›˜åŠ è½½æ•°æ®ï¼Œæ¢å¤äº¤æ˜“æ± çŠ¶æ€ã€‚æ¯”å¦‚ï¼šä»äº¤æ˜“æ± ä¸­æ¸…é™¤æ— æ•ˆäº¤æ˜“æˆ–å·²è¢«æ‰“åŒ…çš„äº¤æ˜“ï¼Œæ›´æ–°å¤„äº pending çŠ¶æ€äº¤æ˜“çš„ nonce å€¼

    ```go
    pool.reset(nil, chain.CurrentBlock().Header()) 
    ```

6.  è®¢é˜…é“¾ä¸Šäº‹ä»¶æ¶ˆæ¯ã€‚æ¯”å¦‚ï¼šçŸ¿å·¥æ‰“åŒ…æˆåŠŸä¸€ä¸ªåŒºå—åï¼Œä¼šé€šè¿‡é€šé“æ¨é€ ChainHeadEvent æ¶ˆæ¯ï¼Œè¿›è€Œè§¦å‘æ¶ˆæ¯è®¢é˜…æœåŠ¡ã€‚

    ```go
     pool.chainHeadSub = pool.chain.SubscribeChainHeadEvent(pool.chainHeadCh) 
    ```

7.  å¯åŠ¨æ–°çº¿ç¨‹,è½®è¯¢äº‹ä»¶æ¶ˆæ¯ã€‚

    ```go
     go pool.loop() 
    ```

    è¯¥è½®è¯¢äº‹ä»¶ä¸»è¦ç”¨äºç›‘å¬ä¸Šä¸€æ­¥é€šé“ä¸­çš„ ChainHeadEvent æ¶ˆæ¯ï¼Œç„¶åè°ƒç”¨`pool.reset`æ–¹æ³•åŒæ­¥è¿œç¨‹åŒºå—æ•°æ®ã€‚

    ```go
     pool.reset(head.Header(), ev.Block.Header()) 
    ```

åˆ°æ­¤ï¼Œäº¤æ˜“æ± çš„æ•´ä½“åŠ è½½è¿‡ç¨‹å°±ç®—ç»“æŸäº†ã€‚

* * *

**é‚£ä¹ˆä»åˆ›å»ºäº¤æ˜“åˆ°è¢«æ‰“åŒ…è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œäº¤æ˜“æ± çš„æ•´ä¸ªæ•°æ®æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ**
![](img/9fce9b498960f101ef0b2e82dba6fe00.jpg)

**é¦–å…ˆ**ï¼Œè¦ææ˜ç™½äº¤æ˜“çš„æ•°æ®æ¥æºã€‚è€Œäº¤æ˜“æ•°æ®æ¥è‡ªäºä¸¤ä¸ªå…¥å£ï¼š
1ï¼‰å®¢æˆ·ç«¯(Ethereum/LightEthereum)é€šè¿‡ç›‘å¬`TxMsg`æ¶ˆæ¯è°ƒç”¨ TxPool å®ä¾‹çš„`AddRemotes`æ–¹æ³•åˆ›å»ºè¿œç¨‹äº¤æ˜“ï¼›

```go
pm.txpool.AddRemotes(txs) 
```

2ï¼‰è°ƒç”¨æœ¬åœ°å®¢æˆ·ç«¯ RPC æœåŠ¡åˆ›å»ºæœ¬åœ°äº¤æ˜“

```go
func (b *EthAPIBackend) SendTx(ctx context.Context, signedTx *types.Transaction) error {
    return b.eth.txPool.AddLocal(signedTx)
} 
```

**ç„¶å**ï¼Œç»Ÿä¸€è°ƒç”¨äº¤æ˜“æ± çš„`addTx`æ–¹æ³•ï¼Œä½†æ˜¯ä¼ å…¥çš„å‚æ•°æœ‰æ‰€ä¸åŒã€‚

```go
pool.addTx(tx, æ˜¯å¦æœ¬åœ°) 
```

**æ¥ä¸‹æ¥**ï¼Œä¼šå¯¹æ•°æ®è¿›è¡Œä¸šåŠ¡æ€§æ ¡éªŒï¼š
1ï¼‰æœ¬åœ°å®¢æˆ·ç«¯æ˜¯å¦å·²å­˜åœ¨å½“å‰äº¤æ˜“ hash
2ï¼‰äº¤æ˜“æ•°æ®å¤§å°æ˜¯å¦è¶…å‡ºå­—èŠ‚é™åˆ¶
3ï¼‰äº¤æ˜“è½¬å¸é‡‘é¢æ˜¯å¦å°äº 0
4ï¼‰äº¤æ˜“ gas å€¼æ˜¯å¦è¶…å‡ºå½“å‰äº¤æ˜“æ± è®¾å®šçš„ gaslimit
5ï¼‰äº¤æ˜“ç­¾åæ˜¯å¦åˆæ³•
6ï¼‰äº¤æ˜“ gasprice åˆ¤æ–­ã€‚å¦‚æœäº¤æ˜“ä¸ºè¿œç¨‹äº¤æ˜“ï¼Œåˆ™éœ€éªŒè¯å…¶ gasprice æ˜¯å¦å°äºäº¤æ˜“æ±  gasprice æœ€å°å€¼
7ï¼‰åˆ¤æ–­å½“å‰äº¤æ˜“ nonce å€¼æ˜¯å¦è¿‡ä½
8ï¼‰åˆ¤æ–­äº¤æ˜“æ‰€éœ€èŠ±è´¹çš„è½¬å¸æ‰‹ç»­è´¹æ˜¯å¦å¤§äºå¸æˆ·ä½™é¢
9ï¼‰åˆ¤æ–­äº¤æ˜“èŠ±è´¹ gas æ˜¯å¦å°äºå…¶é¢„ä¼°èŠ±è´¹ gas

**ä¸‹ä¸€æ­¥**ï¼Œå¦‚æœäº¤æ˜“æ± æ˜¯å¦å·²æ»¡ï¼Œåˆ™æ‹’ç»æ¥å—å°äºå½“å‰ gasprice çš„äº¤æ˜“ä»¥åŠæ¸…é™¤ä¸€æ¡ä¸åœ¨æœ¬åœ°å­˜å‚¨çš„äº¤æ˜“æ•°æ®ã€‚

**å†æ¬¡**ï¼Œåˆ¤æ–­å½“å‰äº¤æ˜“åœ¨ pending é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨ nonce å€¼ç›¸åŒçš„äº¤æ˜“ã€‚å­˜åœ¨åˆ™åˆ¤æ–­å½“å‰äº¤æ˜“æ‰€è®¾ç½®çš„ gasprice æ˜¯å¦è¶…è¿‡è®¾ç½®çš„ PriceBump ç™¾åˆ†æ¯”ï¼Œè¶…è¿‡åˆ™æ›¿æ¢è¦†ç›–å·²å­˜åœ¨çš„äº¤æ˜“ï¼Œå¦åˆ™æŠ¥é”™è¿”å›`æ›¿æ¢äº¤æ˜“ gasprice è¿‡ä½`æç¤º

**æœ€å**ï¼Œå¦‚æœä¸€æ¡æ–°çš„äº¤æ˜“æ²¡æœ‰æ›¿æ¢æ‰ pending ä¸­äº¤æ˜“ï¼Œåˆ™è¯¥äº¤æ˜“è¿›å…¥åˆ° queue é˜Ÿåˆ—ã€‚

```go
replace, err := pool.enqueueTx(hash, tx) 
```

åŒæ ·ï¼Œåœ¨ queue é˜Ÿåˆ—ä¸­ä¹Ÿä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨ nonce å€¼ç›¸åŒçš„äº¤æ˜“ã€‚å¦‚æœå­˜åœ¨åˆ™ä¼šæ ¹æ®å½“å‰äº¤æ˜“ gasprice æ˜¯å¦è¶…å‡ºè®¾ç½®çš„ PriceBump ç™¾åˆ†æ¯”ï¼Œè¶…è¿‡åˆ™æ›¿æ¢ queue ä¸­å­˜åœ¨çš„äº¤æ˜“ï¼Œå¹¶æ¸…é™¤æ—§çš„äº¤æ˜“æ•°æ®ã€‚

**æ³¨æ„ï¼š**pending é˜Ÿåˆ—ä¸ queue é˜Ÿåˆ—éƒ½æ˜¯å¯¹ç”¨æˆ·è¿›è¡Œæ•°æ®æ˜ å°„çš„é›†åˆåˆ—è¡¨ã€‚åœ¨ä¸Šè¿°æ‰€æœ‰åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨æŸé¡¹äº¤æ˜“ï¼Œå…¶å®å°±æ˜¯å¯¹æŸä¸ªç”¨æˆ·çš„äº¤æ˜“åˆ—è¡¨è¿›è¡Œåˆ¤æ–­çš„ã€‚

```go
pending map[common.Address]*txList
queue   map[common.Address]*txList 
```

åˆ°æ­¤ï¼Œæ•´ä¸ªäº¤æ˜“æ± çš„æ•°æ®æµç¨‹å°±ç®—å¤„ç†å®Œæ¯•ï¼Œä¹‹åçš„å¤„ç†é€»è¾‘ä¾¿æ˜¯çŸ¿å·¥ä» pending é›†åˆä¸­è·å–è¦æ‰§è¡Œçš„äº¤æ˜“åˆ—è¡¨è¿›è¡Œæ‰“åŒ…å¤„ç†ã€‚

* * *

åœ¨ä»‹ç»å®Œ Ethereum å®¢æˆ·çš„äº¤æ˜“æ± æ•°æ®ç»“æ„å’Œæµç¨‹åï¼Œæˆ‘ä»¬å†æ¥å¯¹æ¯”ä¸€ä¸‹è½»å®¢æˆ·ç«¯çš„äº¤æ˜“æ± æ•°æ®ç»“æ„åŠå…¶å¤„ç†æµç¨‹ã€‚

## æ•°æ®ç»“æ„

å¯¹æ¯” Ethereum äº¤æ˜“æ± æ•°æ®ç»“æ„ï¼Œè½»å®¢æˆ·ç«¯äº¤æ˜“æ± çš„ä¸åŒä¹‹å¤„åœ¨äºå®ƒå¹¶æ²¡æœ‰æä¾› queue äº¤æ˜“åˆ—è¡¨å±æ€§ï¼Œè€Œæ˜¯å¤šäº†ä¸€ä¸ª`mined`å±æ€§ï¼Œå…¶æ•°æ®ç±»å‹ä¸º`map[common.Hash][]*types.Transaction`

## åˆå§‹åŒ–æµç¨‹

åŒæ ·ï¼ŒTxPool å¯¹è±¡ä¹Ÿæ˜¯åœ¨å®¢æˆ·ç«¯å®ä¾‹åŒ–æ—¶è¢«è°ƒç”¨æ‰§è¡Œçš„ï¼Œåªä¸è¿‡æ˜¯åœ¨å‘ç”Ÿ LightEthereum å®¢æˆ·ç«¯ä¸­ã€‚

```go
leth.txPool = light.NewTxPool(leth.chainConfig, leth.blockchain, leth.relay) 
```

æ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹ï¼Œååˆ†ç®€å•ï¼Œæ€»å…±åˆ†ä¸ºä¸‰æ­¥:
ç¬¬ä¸€æ­¥ï¼šæ ¹æ®å¯åŠ¨å‚æ•°å®ä¾‹åŒ–äº¤æ˜“æ± ã€‚è¿™ä¸€æ­¥ä¸»è¦å°±æ˜¯å¯¹æˆå‘˜å˜é‡è¿›è¡Œå®¹å™¨åˆå§‹åŒ–æ“ä½œï¼›
ç¬¬äºŒæ­¥ã€è®¢é˜…äº‹ä»¶æ¶ˆæ¯ã€‚è¿™ä¸€æ­¥å’Œ Ethereum äº¤æ˜“æ± å®ç°æ˜¯ä¸€æ ·çš„ï¼Œè®¢é˜…çš„éƒ½æ˜¯ ChainHeadEvent äº‹ä»¶æ¶ˆæ¯ï¼Œç”¨ä»¥ç›‘å¬æœ€æ–°åŒºå—æ¶ˆæ¯ã€‚
ç¬¬ä¸‰æ­¥ã€è½®è¯¢äº‹ä»¶æ¶ˆæ¯ã€‚å½“ç›‘å¬åˆ°æ–°çš„åŒºå—æ¶ˆæ¯ä¼šè§¦å‘`setNewHead`æ–¹æ³•ï¼Œå¯¹æ¯”æœ¬åœ°å®¢æˆ·ç«¯æœ€æ–°åŒºå—ä»¥åŠè¿œç¨‹åŒºå—ä¿¡æ¯ï¼Œå½“ä¸¤è€…ä¸ç›¸åŒæ—¶ï¼Œæ¯”å¦‚æœ¬åœ°å®¢æˆ·ç«¯å½“å‰åŒºå—ä½äºè¿œç¨‹åŒºå—ã€è¿œç¨‹åŒºå—ä½äºæœ¬åœ°å®¢æˆ·ç«¯åŒºå—æ—¶ï¼Œå¾ªç¯è°ƒç”¨å®ƒä»¬çš„çˆ¶ç»“ç‚¹ï¼Œç›´åˆ°æ‰¾åˆ°å…±åŒçˆ¶ç»“ç‚¹ï¼Œå¹¶åœ¨æ­¤è¿‡ç¨‹ä¸­ç»Ÿè®¡`oldHashes`ã€`newHashes`åŒºå—åˆ—è¡¨ã€‚

```go
for oldh.Hash() != newh.Hash() {
    if oldh.Number.Uint64() >= newh.Number.Uint64() {
        oldHashes = append(oldHashes, oldh.Hash())
        oldh = pool.chain.GetHeader(oldh.ParentHash, oldh.Number.Uint64()-1)
    }
    if oldh.Number.Uint64() < newh.Number.Uint64() {
        newHashes = append(newHashes, newh.Hash())
        newh = pool.chain.GetHeader(newh.ParentHash, newh.Number.Uint64()-1)
        if newh == nil {
            // happens when CHT syncing, nothing to do
            newh = oldh
        }
    }
} 
```

ç„¶åï¼Œå¦‚æœ`oldHashes`åˆ—è¡¨ä¸­å­˜åœ¨æ•°æ®ï¼Œåˆ™å›æ»šæœ¬åœ°åŒºå—æ•°æ®ï¼›å¦‚æœ`newHashes`åˆ—è¡¨ä¸­å­˜åœ¨æ•°æ®ï¼Œåˆ™æ ¹æ®`newHashes`åŒºå—ä¸­çš„äº¤æ˜“æ•°æ®æ›´æ–°æœ¬åœ° pending äº¤æ˜“æ•°æ®ä¸ºå·²æ‰“åŒ…æ•°æ®ã€‚

## æ•°æ®å¤„ç†æµç¨‹

è½»å®¢ç«¯äº¤æ˜“æ± çš„äº¤æ˜“æ•°æ®æ¥æºåªæœ‰ä¸€ä¸ªï¼Œé‚£å°±æ˜¯ RPC æœåŠ¡è¯·æ±‚å…¥å£

```go
func (b *LesApiBackend) SendTx(ctx context.Context, signedTx *types.Transaction) error {
    return b.eth.txPool.Add(ctx, signedTx)
} 
```

å¯¹æ¯” ethereum, å®ƒå¹¶æ²¡æœ‰`AddRemote`æ–¹æ³•ï¼Œä¸»è¦å› ä¸ºè½»å®¢æˆ·ç«¯æœ¬èº«ä¸æ”¯æŒæŒ–çŸ¿åŠŸèƒ½ï¼Œè¿œç¨‹åŒæ­¥äº¤æ˜“æ•°æ®å¹¶æ²¡æœ‰ä»€ä¹ˆæ„æ€ã€‚è€Œæœ¬åœ°äº¤æ˜“æ˜¯å¦è¢«ç¡®è®¤æ‰“åŒ…ï¼Œä¹Ÿä¸»è¦æ˜¯æ ¹æ®åŒºå—äº‹ä»¶æ¥å®šæ—¶åŒæ­¥å…¶ pending äº¤æ˜“çŠ¶æ€ã€‚

æ‰€ä»¥å®ƒçš„æ•´ä¸ªå¤„ç†æµç¨‹ï¼Œä¹Ÿå¹¶ä¸å¤æ‚ï¼Œä¸»è¦åˆ†ä¸ºä¸¤æ­¥ï¼š
1ï¼‰æœ¬åœ°äº¤æ˜“åˆ›å»ºï¼Œåˆ›å»ºäº¤æ˜“è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆä¹Ÿä¼šè¿›è¡Œå‚æ•°æ ¡éªŒï¼Œæ¯”å¦‚å½“å‰ hash æ˜¯å¦å·²å­˜åœ¨ã€ äº¤æ˜“ç­¾åæ˜¯å¦åˆæ³•ã€äº¤æ˜“ nonce æ˜¯å¦è¿‡ä½ã€gaslimit æ˜¯å¦è¶…è¿‡é™åˆ¶ç­‰ï¼Œå¤§è‡´å’Œ ethereum äº¤æ˜“æ± çš„éªŒè¯é€»è¾‘ç›¸ä»¿ï¼›ç„¶åï¼Œå°†åˆ›å»ºçš„äº¤æ˜“å­˜å…¥ pending äº¤æ˜“åˆ—è¡¨ï¼Œæ›´æ–°å…¶ nonceï¼›åŒæ—¶å‘é€`NewTxsEvent`äº‹ä»¶æ¶ˆæ¯ã€‚
2ï¼‰å‘é€ LesTxRelay æ¶ˆæ¯è‡³æ³¨å†Œåˆ°æœ¬åœ°å®¢æˆ·ç«¯çš„ peer èŠ‚ç‚¹

* * *

æ€»ç»“ï¼Œé€šè¿‡æœ¬å°èŠ‚æ–‡ç« çš„å­¦ä¹ ï¼Œæˆ‘ä»¬äº†è§£äº†ä»¥å¤ªåŠçš„ä¸¤ç§äº¤æ˜“æ± æ•°æ®ç»“æ„ï¼Œäº¤æ˜“æ± çš„åˆå§‹åŒ–æµç¨‹ï¼Œå‘èµ·äº¤æ˜“åˆ°äº¤æ˜“æ‰“åŒ…æ•´ä¸ªé˜¶æ®µè¿‡ç¨‹ä¸­äº¤æ˜“æ± å¤„ç†æµç¨‹ä¸­çš„éªŒè¯é€»è¾‘ä»¥åŠå­˜å‚¨é€»è¾‘ç­‰ã€‚

* * *

> åœ¨æ•™ç¨‹ä¸­å¦‚å‡ºç°ä¸æ˜“ç†è§£æˆ–å­˜åœ¨é”™è¯¯çš„é—®é¢˜ğŸ›ï¼Œæ¬¢è¿åŠ æˆ‘å¾®ä¿¡æŒ‡æ­£ï¼
> Name: zhangliang | WeChat: rushking2009 | Mail: zhangliang@cldy.org