# 第十四章 SHA256

SHA 是一个密码散列函数家族，是英文 Secure Hash Algorithm 的缩写。由美国国家安全局（NSA）所设计，并由美国国家标准与技术研究院（NIST）发布。SHA 家族目前有三个系列：SHA-1，SHA-2，SHA-3。因为 SHA-1 已经被计算出能够被破解，所以现在几乎不再使用。SHA-3 是 2012 年产生的算法，也叫 Keccak 算法，在以太坊公链中主要使用。SHA-2 是当前使用最广泛的算法，尤其是比特币一代的公链。
![](img/54112f828ee75d0d48b7ae121bdcdae7.jpg)

SHA 算法有如下特性：1.不可以从消息摘要中复原信息；2.两个不同的消息不会产生同样的消息摘要。
SHA256 是目前区块链加密算法中最基础也是应用最多的算法。它是 SHA-2 算法系列的最具代表性的加密算法。了解和熟练运用 SHA256 是区块链技术人才的最基本要求。

## 1\. SHA256 的算法原理

SHA-256 是指对于任意小于 2⁶⁴ 位长度（按 bit 计算）的消息，以 512 位的分组为单位进行处理，最终产生一个 32 个字节长度数据的一种加密算法。产生的数据称作消息摘要。因为消息摘要的唯一性和确定性，所以可以用来验证数据在传输过程中是否发生改变，即验证其完整性。

### 1.1 运算单位

SHA 算法过程的处理单位是位。本文中，一个“字”（Word）是 32 位，而一个“字节”（Byte）是 8 位。比如，字符串“abc”可以被转换成一个位字符串：01100001 01100010 01100011。它也可以被表示成 16 进制字符串:0x616263.

### 1.2 补位

将消息转换成二进制串，在后边添加一个“1”和若干个“0”，使其长度模 512 余数为 448。以信息“abc”为例显示补位的过程。

　　原始信息：01100001 01100010 01100011
　　补位第一步：0110000101100010 01100011 1
　　首先补一个“1”
　　补位第二步：0110000101100010 01100011 10…..0
　　然后补 423 个“0” 　　

### 1.3 消息填充　

将补位过的信息再追加一个 64 位的消息长度信息，使得填充完成后的消息长度正好是 512 位的整数倍。追加的 64 位的消息长度信息是原始消息的位长，填充完成的消息会被分成 512 位的消息分组。 　　

### 1.4 初始向量

SHA256 是一个 Merkle-Damgard 结构的迭代哈希函数，进行第一次运算的时候需要一个初始向量。该向量在整个运算过程中是一个变量。SHA256 的初始变量是取自然数前 8 个素数（2，3，5，7，11，13，17，19）的平方根的小数部分前 32bit 的值。如 2 的平方根取小数部分是：0.414213562373095048...，转换成二进制取前 32bit 值是：10110111111100101010000101001010，然后将其转换成 16 进制的值是：0x6a09e667。同样我们也会得到其他素数的初始变量。这些初始变量存储于 8 个寄存器 A、B、C、D、E、F、G 和 H 中，分别是：

A= H[0] = 0x6a09e667
B= H[1] = 0xbb67ae85
C= H[2] = 0x3c6ef372
D= H[3] = 0xa54ff53a
E= H[4] = 0x510e527f
F= H[5] = 0x9b05688c
G= H[6] = 0x1f83d9ab
H= H[7] = 0x5be0cd19

### 1.5 使用的 64 个常量

在 SHA256 算法中，用到 64 个常量，这些常量是对自然数中前 64 个素数的立方根的小数部分取前 32bit 而来。其作用是提供了一个 64 位随机串集合，用于被随机选取作为改变每次消息块运算初始向量函数的参数。这样每次消息块加密运算时，输入的初始向量都是没有任何规则的。这 64 个常量如下：

```go
 428a2f98 71374491 b5c0fbcf e9b5dba5 
    3956c25b 59f111f1 923f82a4 ab1c5ed5 
    d807aa98 12835b01 243185be 550c7dc3 
    72be5d74 80deb1fe 9bdc06a7 c19bf174 
    e49b69c1 efbe4786 0fc19dc6 240ca1cc 
    2de92c6f 4a7484aa 5cb0a9dc 76f988da 
    983e5152 a831c66d b00327c8 bf597fc7 
    c6e00bf3 d5a79147 06ca6351 14292967 
    27b70a85 2e1b2138 4d2c6dfc 53380d13 
    650a7354 766a0abb 81c2c92e 92722c85 
    a2bfe8a1 a81a664b c24b8b70 c76c51a3 
    d192e819 d6990624 f40e3585 106aa070 
    19a4c116 1e376c08 2748774c 34b0bcb5
    391c0cb3 4ed8aa4a 5b9cca4f 682e6ff3 
    748f82ee 78a5636f 84c87814 8cc70208 
    90befffa a4506ceb bef9a3f7 c67178f2 
```

### 1.6 运算过程

运算过程简单描述如下：

1.  创建 8 个变量 a,b,c,d,e,f,g,h，并分别赋值初始向量对应的值；
2.  将原始消息补位和填充后，分为 N 个 512bit 的消息块 M(i)；
3.  运算 M 有个大的循环，形如： For i =1 to N;
4.  大循环里面有个 64 次的循环，用于改变 8 个变量，并将最终改变后的 8 个变量作为下一次大循环的参数；
5.  大循环最后得到的 a,b,c,d,e,f,g,h 拼接在一起就是最后的长度为 256 位的消息摘要。

    下边分析一下 64 次的循环里面的具体函数，伪代码如下：
    For t = 0 to 63
    T1 = （h +（∑1 + CH(e,f,g) + Kt + Wt）mod2³²
    T2 = ∑0 + MAJ(a,b,c)mod2³²
    h = g
    g = f
    f = e
    e = (d + T1)mod2³²
    d = c
    c = b
    b = a
    a = (T1 + T2)mod2³²
    其中∑1 和∑0 分别是 e 和 a 的位移异或函数，表达式不做展开；与异或运算函数；MAJ(a,b,c)是 a，b，c 之间异或运算加法运算函数，表达式不做展开，；T1 和 T2 是每一步生成的两个临时变量；Kt 是每次循环从随机串里随机选取的数值；Wt 是对输入的消息块的处理函数。

    消息块的处理：每个消息块分解为 16 个 32-bit 的 big-endian 的字，记为 w[0], …, w[15]。也就是说，前 16 个字直接由消息的第 i 个块分解得到，其余的字由如下迭代公式得到，这样 Wt 的表达式如下表示：
    Wt=w[t],0<=t<=16
    Wt=σ1(Wt−2)+Wt−7+σ0(Wt−15)+Wt−16,16<=t<=63
    最后一次循环所产生的八个字合起来即是第 i 个块对应到的散列字符串 Hi 就是 sha256 加密后的散列值。

## 2\. SHA256 在区块链的应用及代码实现

SHA256 从出现到现在，目前被证明是很安全的，其在区块链上的应用最为广泛，如比特币的挖矿算法，产生账户地址和区块产生 hash，以及以太坊区块生成 hash 等等。
它的使用非常简单，golang 库里已经封装好了 SHA256 的具体算法，所以我们在使用时直接调用方法就可以。函数 hash.Sha256 的参数类型是字节切片，返回值也是字节切片，在使用时需要注意。
Go 代码实现 SHA256 有两种方法，原理和输出都一样，代码如下：

```go
package main

import (
    "github.com/nebulasio/go-nebulas/crypto/hash"
    "fmt"
    "encoding/hex"
    "crypto/sha256"
)

func main()  {

    a:="helloworld"

    //方法 1：一个方法直接输出
    hash:=hash.Sha256([]byte(a))
    fmt.Println(hex.EncodeToString(hash))

    sha256.New()

    //方法 2：按步骤一步步输出
    h := sha256.New() //创建 sha256 算法
    h.Write([]byte(a)) //用 sha256 算法对参数 a 进行加密，得到 8 个变量
    hash1 := h.Sum(nil) //将 8 个变量相加得到最终 hash

    fmt.Println(hex.EncodeToString(hash1))

}

//输出

936a185caaa266bb9cbe981e9e05cb78cd732b0b3280eb944412bb6f8f8f07af
936a185caaa266bb9cbe981e9e05cb78cd732b0b3280eb944412bb6f8f8f07af 
```