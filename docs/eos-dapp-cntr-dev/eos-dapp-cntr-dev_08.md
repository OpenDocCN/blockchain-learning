# 2.4 DICE 游戏项目——开发进度

> 下面按照功能结构将 DICE 游戏项目开发步骤进行拆分。
> 
> *   第一阶段：开发环境搭建、熟悉 EOS 合约语法、项目功能需求、接口文档、整体架构设计
> *   第二阶段：DICE 合约监听转账通知实现押注
> *   第三阶段：后端传递种子给合约开奖
> *   第四阶段：前端(基于 Web、钱包 App)使用 Scatter API、RESTful API 和 websocket 与合约、后端交互
> *   第五阶段：实现 diceToken 合约
> *   第六阶段：实现分红合约设计 Token 通证经济模型
> *   第七阶段：合约安全——漏洞攻击与防范
> *   第八阶段：测试，部署合约、部署后端、部署前端

### 第一阶段：开发环境搭建、熟悉 EOS 合约语法、项目功能需求、接口文档、整体架构设计

今天的工作是为合约开发前做准备，熟悉合约开发所需技术

1.  熟悉 UI 设计图、产品需求文档、架构设计文档、开发进度文档、前端接口文档
2.  使用脚本或者 docker 搭建 EOS 环境(本教程使用的是 EOSIO V1.2.6)
3.  熟悉使用 cleos 命令行工具
4.  创建本项目所需账号
5.  创建并发行 EOS 和 JXB 代币
6.  熟悉 C++基本语法
7.  使用 C++编写 helloworld 合约，并使用 cleos 编译、部署、运行合约
8.  了解 EOS 合约语法，如：多索引表、inline action、defer action、eosio.code 权限等
9.  熟练 NodeJS 语言
    *   熟悉 VSCode 编辑器
    *   创建后端项目 diceContract 并集成 eosjs 库
    *   编写 nodejs 脚本 deploy.js 实现编译与部署合约
    *   编写 nodejs 脚本 test.js 实现调用合约

### 第二阶段：DICE 合约处理转账通知实现押注

1.  构建 dice 合约
2.  用 C 实现 apply 方法分发合约 action
3.  apply 方法中监听 transfer 方法并触发 create action，即押注
4.  在 test.js 脚本中使用 openssl 生成随机的 18 位长度的 base64 数据，即种子
5.  获取转账的 memo 里的玩家押注数据：种子、押注数、推荐者
6.  定义多索引表 betings，用于记录玩家押注数据
7.  储存玩家押注数据到 betings 表中
8.  实现 removedb action 用于删除表所有数据
9.  完善 dice 合约：权限认证、押注额限制、过滤不合法的转账押注
10.  在 test.js 脚本中调用 eosjs 库实现押注与获取押注的所有数据

### 第三阶段：后端传递种子给合约开奖

1.  在 test.js 中使用 openssl 生成随机的 32 位长度的十六进制数据，即种子

2.  dice 合约增加开奖方法，即 receipt action

3.  获取 betings 中最早未开奖游戏的押注数据，然后在表中删除

4.  根据种子参数获取开奖结果，即实现随机函数

5.  定义多索引表 beteds，记录已经开奖后的押注数据，并将 user(玩家)、seed(种子)作为二级索引

6.  储存玩家押注、开奖数据到 beteds 表中

7.  判断玩家赢了则赔钱给玩家

8.  提取玩家押注额的 1.5%到奖池用于分红

9.  在 test.js 中调用合约的 receipt action 并传递种子实现开奖

10.  当玩家押注时，在 test.js 中实现自动为玩家开奖

11.  测试合约逻辑与合约安全。至此，完成 DICE 合约开发

12.  可选功能：

    合约实现控盘功能，适当降低玩家赢的概率

    给前端增加开奖结果的公平性验证接口

### 第四阶段：前端(基于 Web、钱包 App)使用 Scatter API、RESTful API 和 websocket 与合约、后端交互

**第一部分：**开发后端项目 diceServer 自动调用合约开奖

1.  定时器轮训查询合约 betings 表中的数据
2.  若有押注数据，则使用 openssl 随机生成的种子调用合约开奖 aciton

**第二部分：**根据前端接口文档开发后端 webServer 项目

1.  创建 NodeJS 后端项目 webServer，并集成 socket.io、集成 Express 框架、实现 http 接口，使前端能访问。
2.  http 接口：

| 接口 | 备注 |
| --- | --- |
| 最新三十条所有投注 | 用于玩家刚进入前端页面时，需要显示的所有投注数据 |
| 前端转账的 seed | 前端调用转账押注时，memo 中包含 seed 种子 |
| 我的余额 | 包含我的 EOS、JXB 余额 |

3.  websocket 接口：

| 接口 | 备注 |
| --- | --- |
| 所有投注 | 后端将玩家最新的投注数据推送给前端 |

**第三部分：**开发 React 项目实现前端、后端、合约之间的交互

1.  在 Google 浏览器中安装 Scatter 钱包插件
2.  配置好 Scatter 钱包与 TokenPocket 钱包 App 的开发环境，包含：EOS 节点配置、导入 EOS 账号
3.  搭建 React 项目，熟悉使用 Scatter API 实现 DICE 押注
4.  并使用 TP 钱包 App、Google 浏览器的 DApp，押注测试成功
5.  在 React 中集成 socket.io 并订阅，使后端能通过 socket 推送消息给前端
6.  至此，实现了 dice 合约、webServer 后端、React 前端之间相互交互

**第四部分：**测试

1.  至此，完成 Dice 游戏项目基本功能。下面学习社区运营所需的通证经济

### 第五阶段：实现 diceToken 合约

1.  构建 diceToken 合约
2.  基于 eosio.token 合约在 diceToken 中实现创建、发行、转账功能
3.  实现质押 Token 功能，必须根据前端接口文档定义质押 action
4.  实现赎回功能，必须根据前端接口文档定义赎回 action
5.  实现挖矿发行代币功能
6.  根据游戏挖矿数量实现逐步减半奖励数量，同时逐步解锁为项目方发行 JXB Token
7.  另外需提供的 ABI：获取押注奖励 JXB 的个数、获取质押数量
8.  在后端项目 diceContract 中的 test.js 中实现调用 diceToken 各个 action
9.  测试合约逻辑与合约安全。至此，完成 diceToken 合约开发

### 第六阶段：实现分红合约设计 Token 通证经济模型

#### 1\. 开发 pool 合约

**第一部分：**构建 pool 合约，监听 transfer 方法触发 create action，即完成分红

1.  获取游戏合约账号转账的 memo 里的数据：玩家账号名称、推荐者、押注 id
2.  给玩家的推荐者分红 10%
3.  增加给分红池 50%的分红金额
4.  增加给英雄榜 9%的分红金额
5.  给项目方剩余利润
6.  英雄榜：增加玩家当前小时的累计押注金额
7.  VIP：增加玩家累计押注金额，并奖励 VIP 回扣
8.  调用 diceToekn 合约发行挖矿代币

**第二部分：**pool 合约中实现奖池开奖 action(由后端整点触发)

1.  获取英雄榜用户押注数据，且按照押注金额降序排序

2.  获取分红池各种 Token 金额

3.  获取 JXB 代币质押总数

4.  计算英雄榜靠前的玩家的分红金额，将英雄榜分红金额减半的算法全部进行分配

5.  开始分红：

    英雄榜：根据押注金额排名，分别增加英雄榜分红金额

    分红池：根据玩家质押占比分配分红池各种 Token 金额，去增加玩家分红金额

6.  记录分红池每小时的分红记录

**第三部分：**pool 合约中实现分红余额提现 action

1.  必须根据前端接口文档定义分红余额提现 action
2.  遍历该玩家在分红余额表中的各种 Token 的余额
3.  若余额大于零，则调用 token 合约由 pool 合约账号转帐相应金额
4.  在 test.js 中编写测试用例，调通 pool 合约 action

#### 2\. 开发 NodeJS 后端实现 pool 合约相关功能与接口

**第一部分：**开发后端 diceServer 项目

1.  整点触发调用 pool 合约的开奖 action

**第二部分：**根据前端接口文档开发后端 webServer 项目

1.  http 接口：

    | 接口 | 备注 |
    | --- | --- |
    | 我的－网络资源数据 | 包含我的 CPU、NET 的总量和已使用量 |
    | 首页—代币奖励数量 | 即游戏挖矿 JXB 的数量 |
    | 分红池－我的质押数量 | 即质押的 JXB 数量 |
    | 分红池－分红记录 | 可按天查询每小时的分红记录，包含 EOS、JXB |
    | 分红池－我的余额 | 是分红余额，注意与账户余额不一样 |
    | VIP－等级 | 每个等级获取的奖励不一样 |
    | VIP－我的累计押注额 | 根据我的累计押注额判定是 VIP 的哪个 |

2.  websocket 接口：

    | 接口 | 备注 |
    | --- | --- |
    | 分红数据： | 包含英雄榜用户押注数据、英雄榜分红金额列表、分红各种代币的总额、代币质押总数。 |

3.  合约接口

    | 接口说明 | 合约接口定义 |
    | --- | --- |
    | 分红池－质押代币 | void stake(account_name owner, asset value) |
    | 分红池－赎回代币 | void unstake(account_name owner, asset value) |
    | 分红池－提现 | void drawdividend(const account_name user) |

### 第七阶段：合约安全——漏洞攻击与防范

1.  整数溢出攻击与防范
2.  随机数攻击与防范
3.  重放攻击与防范
4.  假 EOS 攻击与防范
5.  假转账通知攻击与防范
6.  交易回滚攻击与防范
7.  内联反射攻击与防范
8.  同名混淆交易攻击与防范
9.  敏感权限攻击与防范
10.  私钥泄漏防范
11.  拒绝服务/交易阻塞/交易延迟/交易排挤攻击与防范

### 第八阶段：测试，部署合约、部署后端、部署前端

**第一部分：**测试，开发完成 Dice 游戏项目

1.  修改提供的 React 项目中的配置文件的相关数据，如：后端服务 ip、合约账号名称等
2.  在局域网中使用 TP 钱包、Google 浏览器测试 Dice 游戏项目
3.  至此，完成 Dice 游戏项目开发。

**第二部分：**部署合约

1.  给合约账号购买 RAM、抵押获取 NET 与 CPU
2.  配置 eosjs 连接到 EOS 主网，使用 deploy.js 部署合约到主网

**第三部分：**部署后端

1.  服务器搭建 Node.js/Nginx/PM2 环境
2.  服务器与 Git 仓库读写配置
3.  PM2 一键部署线上 Node.js 项目

**第四部分：**部署前端

1.  前端代码编译、打包
2.  域名 DNS 解析配置及 Nginx 域名配置

**版权声明：博客中的文章版权归博主所有，转载请联系作者（微信：lixu1770105）。**