# 11.5 Multi-Index å®Œæ•´ç”¨æ³•åŠç¤ºä¾‹è®²è§£---ç´¢å¼•å™¨å®šä¹‰ç¯‡

æœ¬å°èŠ‚å°†å‘å¤§å®¶ä»‹ç»å¦‚ä½•å¯¹è‡ªå®šä¹‰æ•°æ®ç»“æ„ä½“å®šä¹‰ä¸»é”®ç´¢å¼•ã€äºŒçº§å­—æ®µç´¢å¼•ï¼Œå¹¶é€šè¿‡ä»£ç ç¤ºä¾‹çš„å½¢å¼æ–¹ä¾¿å¤§å®¶ç†è§£ã€‚

æœ¬æ–‡å°†åˆ†ä¸¤éƒ¨åˆ†è¿›è¡ŒçŸ¥è¯†ç‚¹è®²è§£ï¼š

*   æ™®é€šç´¢å¼•å®šä¹‰
*   äºŒçº§ç´¢å¼•å®šä¹‰

* * *

### 1\. æ™®é€šç´¢å¼•å®šä¹‰

```js
typedef eosio::multi_index< [TableName], [T] > [index_type];
```

ç´¢å¼•å®šä¹‰ä¸»è¦ç”±ä¸‰ä¸ªå‚æ•°è¿›è¡Œå®šä¹‰ï¼š

**TableName**ï¼šæ•°æ®ç»“æ„ä½“æ‰€å¯¹åº”çš„è¡¨åï¼Œå…¶åç§°é•¿åº¦ä¸å¯è¶…è¿‡ 12 ä¸ªå­—ç¬¦ï¼Œä¸”åç§°åªå…è®¸ç”±å°å†™å­—æ¯ã€æ•°å­— 1 åˆ° 5ã€. ä¸‰ç§å­—ç¬¦æ„æˆã€‚ **T**ï¼š ä¸ºæ•°æ®ç»“æ„ä½“åç§° **index_type**: ç´¢å¼•å™¨ç±»å‹åˆ«åã€‚éœ€è¦é’ˆå¯¹ä¸åŒçš„ç»“æ„ä½“è¿›è¡Œä¸åŒçš„ç´¢å¼•å™¨å®šä¹‰ã€‚

å› ä¸ºç¼ºçœç´¢å¼•å™¨æ˜¯åŸºäºä¸»é”®æ—¶æŸ¥è¯¢çš„ï¼Œæ‰€ä»¥åœ¨å®šä¹‰ç»“æ„æ—¶ï¼Œéœ€å†…éƒ¨å¿…é¡»å®ç°ä¸€ä¸ªåä¸º`primary_key()Â `ä¸”è¿”å›å€¼å¿…é¡»ä¸º uint64_t æ•°æ®ç±»å‹çš„æˆå‘˜å¸¸å‡½æ•°ã€‚

è¦å®ç°ä¸€ä¸ªç®€å•çš„ç´¢å¼•å™¨å®šä¹‰ï¼Œå¯åˆ†ä¸ºä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š

1.  å®šä¹‰ç»“æ„ä½“

    ```js
    struct user {
        uint64_t account_name;
        uint64_t age;
    };
    ```

2.  å®šä¹‰ä¸»é”®æŸ¥è¯¢æ–¹æ³• åœ¨ä¸Šè¿°ç»“æ„ä½“ä¸­ï¼Œå®ç°`primary\_key()Â `æ–¹æ³•

    ```js
    uint64_t primary_key() const { return account_name; }
    ```

3.  å®šä¹‰ç´¢å¼•å™¨

    ```js
    typedef eosio::multi_index< "user"_n, user > user_index;
    ```

4.  å®ä¾‹åŒ–ç´¢å¼•å™¨ åœ¨å®ä¾‹åŒ–ç´¢å¼•å™¨`multi_index (name code, uint64_t scope)Â `æ—¶ï¼Œéœ€è¦ä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼š codeã€scopeã€‚**code**å‚æ•°æŒ‡è¡¨æ‰€å½’å±çš„åˆçº¦å¸æˆ·ï¼Œå³ä½ æ‰€è¦æŸ¥è¯¢æˆ–å¤„ç†çš„æ•°æ®æ˜¯å“ªä¸ªåˆçº¦å¸æˆ·ä¸‹é¢çš„æ•°æ®ï¼›**scope**å‚æ•°ä¸»è¦ç”¨äºå¯¹è¡¨æ•°æ®çš„åˆ†è¡¨å¤„ç†ã€‚æ¯”å¦‚æŒ‰å¸æˆ·è¿›è¡Œæ•°æ®éš”ç¦»ï¼Œscope å‚æ•°å°±ä¼ å…¥å¯¹åº”å¸æˆ·åã€‚

    ```js
    user_index userestable(_self, _self.value); // code, scope
    ```

å®Œæ•´ç¤ºä¾‹å¦‚ä¸‹:

```js
#include <eosiolib/eosio.hpp>
using namespace eosio;
using namespace std;

class booking : contract {
  struct user {
     uint64_t account_name;
     uint64_t age;

     uint64_t primary_key() const { return account_name; }
  };
  public:
    booking (name self):contract(self) {}

    typedef eosio::multi_index< "user"_n, user > user_index;

    void createuser(name user, uint64_t age) {
      user_index userestable(_self, _self.value); // code, scope
    }
}
EOSIO_DISPATCH( booking , (myaction) )
```

* * *

### 2\. äºŒçº§ç´¢å¼•å®šä¹‰

é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¾ˆå¯èƒ½ä¼šå¯¹æŸä¸€å¼ è¡¨æ•°æ®è¿›è¡Œå¤šä¸ªå­—æ®µçš„æ•°æ®è¡¨ç»Ÿè®¡æŸ¥è¯¢ã€‚

é‚£ä¹ˆï¼Œè¿™æ—¶å€™å°±éœ€è¦è¿›è¡ŒäºŒçº§ç´¢å¼•å®šä¹‰ã€‚

```js
typedef eosio::multi_index< [TableName], [T],
    indexed_by< 
        [IndexName], 
        const_mem_fun<[T], [IndexFieldType], [FieldGetter]>
    >
  > user_index;
```

ä¸æ™®é€šç´¢å¼•å™¨çš„å®šä¹‰æ–¹å¼ç›¸æ¯”ï¼ŒäºŒçº§ç´¢å¼•å¤šå‡ºä¸€ä¸ª`indexed\_by`çš„æ‰©å±•å®šä¹‰ã€‚`indexed\_by`éœ€è¦è¿›è¡Œå››ä¸ªå‚æ•°å®šä¹‰ï¼š

```js
indexed_by< 
        [IndexName], 
        const_mem_fun<[T], [IndexFieldType], [IndexFieldGetter]>
    >
```

**IndexName**: äºŒçº§ç´¢å¼•åç§°ã€‚å…¶å‘½åé•¿åº¦ä¸å¯ä»¥è¶…è¿‡ 13 ä¸ªå­—ç¬¦ï¼Œå…¶ä¸­å‰ 12 ä¸ªå­—ç¬¦åªå…è®¸ç”±å°å†™å­—æ¯ã€æ•°å­— 1 åˆ° 5ã€. ä¸‰ç§å­—ç¬¦æ„æˆï¼Œç¬¬ 13 ä¸ªå­—ç¬¦åªå…è®¸ä» a-p å°å†™å­—æ¯æˆ–.ä¸¤ç±»å­—ç¬¦ä¸­é€‰æ‹© **T**ï¼š æ•°æ®ç»“æ„ä½“åç§° **IndexFieldType**ï¼šäºŒçº§ç´¢å¼•å­—æ®µæ•°æ®ç±»å‹ã€‚ç›®å‰æ‰€æ”¯æŒçš„æ•°æ®ç±»å‹ä»…æ”¯æŒä»¥ä¸‹å‡ ç§

*   uint64_t
*   uint128_t
*   eosio::checksum256
*   double
*   long doubleã€‚ **Â IndexFieldGetter**ï¼šæ•°æ®ç»“æ„ä½“å±æ€§ getter æ–¹æ³•

**æ³¨** ï¼šç´¢å¼•å™¨ç›®å‰æœ€å¤šæ”¯æŒ 16 ä¸ªäºŒçº§ç´¢å¼•ã€‚

ç°åœ¨å¯¹æ™®é€šç´¢å¼•å™¨æ‰€æä¾›çš„ä»£ç ç¤ºä¾‹ï¼Œè¿›è¡ŒäºŒçº§ç´¢å¼•æ‰©å±•ï¼Œæ–°å¢`age`å­—æ®µäºŒçº§ç´¢å¼•

1.  åœ¨æ•°æ®ç»“æ„ä½“ä¸­ï¼Œæ·»åŠ äºŒçº§ç´¢å¼•å­—æ®µ

    ```js
    struct user {
        uint64_t account_name;
        uint64_t age;   //æ–°å¢ç´¢å¼•å­—æ®µ

        uint64_t primary_key() const { return account_name; }
    }
    ```

2.  åœ¨æ•°æ®ç»“æ„ä½“ä¸­ï¼Œå®šä¹‰å¯¹äºŒçº§ç´¢å¼•å­—æ®µçš„æŸ¥è¯¢æ–¹æ³•

    ```js
    uint64_t by_age() const { return age; }
    ```

    åœ¨ user æ•°æ®ç»“æ„ä½“ä¸­ï¼Œå®šä¹‰å¯¹**age**å­—æ®µçš„æŸ¥è¯¢æ–¹æ³•

3.  åœ¨ç´¢å¼•å™¨ä¸­æ·»åŠ äºŒçº§ç´¢å¼•å®šä¹‰

    ```js
    typedef eosio::multi_index< "user"_n, user,
        indexed_by< 
            "byage"_n, 
            const_mem_fun<user, uint64_t, &user::by_age> 
        >
    > user_index;
    ```

4.  å®ä¾‹åŒ–ç´¢å¼•å™¨ï¼Œå¹¶è·å–äºŒçº§ç´¢å¼•å®ä¾‹

    ```js
    //1\. å®ä¾‹åŒ–ç´¢å¼•å™¨
    user_index userestable(_self, _self.value); // code, scope

    //2\. å®ä¾‹åŒ–äºŒçº§ç´¢å¼•
    auto age_index = userestable.get_index<"byage"_n>();
    ```

* * *

é€šè¿‡æœ¬å°èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰äº†æ•´ä¸ªç´¢å¼•å™¨ä»å®šä¹‰æ•°æ®ç»“æ„ä½“ã€ä¸»é”®ä¸äºŒçº§ç´¢å¼•å®šä¹‰ä»¥åŠç´¢å¼•å™¨ã€äºŒçº§ç´¢å¼•å®ä¾‹åŒ–çš„å®Œæ•´å¼€å‘æµç¨‹ã€‚

* * *

> åœ¨æ•™ç¨‹ä¸­å¦‚å‡ºç°é”™è¯¯ğŸ›æˆ–ä¸æ˜“ç†è§£çš„çŸ¥è¯†ç‚¹ï¼Œæ¬¢è¿åŠ æˆ‘å¾®ä¿¡æŒ‡æ­£! Name: zhangliang | WeChat: rushking2009 | Mail: zhangliang@cldy.org

![](img/9c507c40d372f5692d061c802a44deb2.jpg)![](img/aab6c923225b0a35b6580de17534641d.jpg)

* * *

### **changelog**

2019-03-21 zhangliang(mailto:zhangliang@cldy.org)

*   åˆæ¬¡å‘ç¨¿