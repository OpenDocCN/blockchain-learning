# 6.8 订单薄搓合设计与实现

# 搓合功能设计与实现

本小节主要介绍在交易所的关键功能即搓合业务。如何检查订单队列中是否存在可以搓合的订单？搓合的条件是什么以及在搓合过程需要注意哪些细节呢？本小节将带你了解其内部实现细节。

注：本交易所项目目前只支持限价交易。

## 功能介绍

搓合功能：主要当检查到订单薄队列中出现买单价高于卖单价的订单时，自动触发搓合逻辑。根据搓合成交量同步更新订单薄、用户订单、资金信息并自动将成交代币转帐至对方帐号的一整套完整流程。

示例：在交易所中搓合过程中，往往会遇到以下四种情况（限价交易）：

**完全成交， 价格相同** 买方：以 0.01EOS 单价购买 100 个 DICE 卖方：以 0.01EOS 单价售卖 100 个 DICE 当搓合成功后，则买方获得 100 个 DICE， 而卖方获得 1 个 EOS 。

**完全成交， 价格不同** 买方：以 0.02 EOS 购买 100 个 DICE 卖方：以 0.01 EOS 售卖 100 个 DICE 当搓合成功后，则买方获得 100 个 DICE，卖方获得 1EOS， 交易所获得 1EOS 。

**部分成交，价格相同** 买方：以 0.01 EOS 购买 100 个 DICE 卖方：以 0.01 EOS 售卖 50 个 DICE 当搓合成功后，则买方获得 0.5EOS、50DICE， 卖方获得 0.5EOS。而买方订单薄中还有 0.5 个 EOS 未成交

**部分成交，价格不同** 买方：以 0.02EOS 购买 100 个 DICE 卖方：以 0.01EOS 售卖 50 个 DICE
当搓合成功后，则买方获得 0.01EOS、50DICE， 卖方获得 0.5EOS，交易所获得 0.5EOS；而买方订单薄还有 1 个 EOS 未成交。

## 业务约束

*   搓合买、卖订单必须币种一致
*   搓合买单价格必须大于或等卖单价格
*   搓合订单时需同步更新订单薄、用户订单、资金数据。

## 业务流程

1.  通过后端中心化服务检查所有交易对的买、卖单队列，按照价格优先时间优先的策略检查是否存在匹配的订单
2.  存在则调用智能合约搓合方法
3.  检查搓合的买、卖订单价格是否符合：买单价大于等于卖单价格
4.  检查搓合的买、卖订单币种是否一致
5.  检查交易对是否存在
6.  根据买、卖订单交易量计算**成交量**，区分判断完全成交或部分成交
7.  根据**成交量**更新订单薄订单交易量
8.  根据**成交量**更新用户订单交易量及状态信息
9.  解锁买卖双方帐户冻结资金；
10.  更新买卖双方帐户余额
11.  将成交量的代币直接转帐到对方帐号
12.  生成搓合日志记录同步到链上

## 安全问题

*   权限验证, 仅限搓合业务管理员进行操作。
*   方法分级授权
    可根据管理角色进行细粒度方法权限授权，确保关键业务由高级别管理员控制。比如：对于资金的提现功能只允许最高级别管理员操作；而合约的基础数据操作可交由运维管理员进行操作。

## 技术实现

由项目成员自主设计与实现。

## 涉及命令知识点

*   查看 Docker 服务

    ```js
    docker ps
    ```

*   进入 Docker 命令窗口

    ```js
    docker exec -it <container name> /bin/bash
    ```

*   解锁钱包

    ```js
    cleos wallet unlock -n <钱包名称> --password <钱包密码>
    # 例如: 打开名称为 hackdappexch 的钱包
    cleos wallet unlock -n hackdappexch --password $(cat hackdappexch_wallet_password.txt);
    ```

*   发布合约

    ```js
    cleos set contract <合约名> <合约目录> -p <合约名>@active
    ```

*   调用合约方法

    ```js
    cleos push action <合约名> <合约方法> [<参数 1>,<参数 2>] -p <合约名>@active
    ```

*   查询数据表

    ```js
    cleos get table <合约名> <scope> <表定义>
    # scope 值取决于实例化索引时所传入的值, 一般实例化索引时传入 _self,即合约本身。
    ```

* * *

通过本章节的学习以及动手实践， 我们掌握了整个搓合的详细业务逻辑并且实现了搓合业务方法。

* * *

> 在教程中如出现错误🐛或不易理解的知识点，欢迎加我微信指正! Name: zhangliang | WeChat: rushking2009 | Mail: zhangliang@cldy.org

* * *

#### **changelog**

2019-03-02 zhangliang

*   初次发稿