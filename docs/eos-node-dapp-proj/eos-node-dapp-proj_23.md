# 七、.5 同步区块功能设计与实现

上一小节讲述了搓合功能的业务实现，那么本小节将介绍如何发现链上搓合成交日志，如何增量同步订单数据至中心化数据库以及如何根据规划实时更新 K 线图报表数据

## 功能介绍

区块同步功能，主要是通过定时调度，实时检查链上成交订单信息，如果新成交订单则同步至线下成交订单库，并按一定业务规则更新 K 线图报表数据。

## 数据结构

**成交订单表**

| 字段 | 数据类型 | 说明 |
| --- | --- | --- |
| 主键 | bigint |  |
| 交易对 ID | bigint |  |
| 成交量 | bigint |  |
| 成交价格 | bigint |  |
| 成交时间 | timestamp |  |
| 买方帐户 | varchar |  |
| 买方价格 | bigint |  |
| 买方订单 ID | bigint |  |
| 买方备注 | varchar |  |
| 卖方帐户 | varchar |  |
| 卖方价格 | bigint |  |
| 卖方订单 ID | bigint |  |
| 卖方备注 | varchar |  |
| 最后更新时间 | timestamp |  |
| 最后更新区块 | bigint |  |

**K 线图报表**

| 字段 | 数据类型 | 说明 |
| --- | --- | --- |
| 交易对 ID | bigint |  |
| 时间 | bigint | 按分钟汇总成交订单数据 |
| 开盘价 | bigint | 当前区间维度开盘第一单成交价；比如：按日线图查询时，若开盘半小时内无成交价则取前一天收盘价； |
| 收盘价 | bigint | 当前区间维度最后一单成交价 |
| 最高价 | bigint | 当前区间维度最高价 |
| 最低价 | bigint | 当前区间维度最低价 |
| 成交量 | bigint | 当前区间维度总成交量单数 |

## 调度配置

根据 cron 表达式触发调度任务。

## 权限要求

同步功能只是查询合约数据并同步至本地库，对智能合约无安全性问题。

## 技术实现

本功能实现逻辑，可拆分为三个业务模块实现：

1.  如何查询链上成交记录
    查询链上成交数据，原理是通过调用`eos.getActions(contractname, pos, offset)`方法筛选合约中的日志方法，从而获取具体的成交明细。但需要注意的是提供查询的链节点必须事先加载 history_plugin 插件，否则查到的数据为空。所以将来部署服务时，需要注意所要链接的节点不管是自己搭建还是第三方链结点都必须配置 history_plugin 插件。
2.  同步链上成交记录至本地订单表
    当查询到链上成交记录后，需要**增量同步**至本地库。关于增量的处理可以根据当前库中最后一条记录的区块 ID 与链上区块 ID 对比处理。
3.  根据报表要求聚合成交数据至 K 线图报表
    因为 K 线图支持 5 分钟、10 分钟、按小时、按天等不同维度的数据查看，考虑到数据库性能要求，我们可以根据维度对多报表(分钟表、 小时表、天表)进行数据聚合更新。注意：在聚合数据时，需要开盘价、收盘价、最高价、最低规则进行处理后再更新。

* * *

通过本小节的学习、思考与动手实践，我们完成了链上成交订单的数据同步以及 K 线图报表数据的更新。

* * *

> 在教程中如出现错误🐛或不易理解的知识点，欢迎加我微信指正! Name: zhangliang | WeChat: rushking2009 | Mail: zhangliang@cldy.org

![Show me your code.](img/9c507c40d372f5692d061c802a44deb2.jpg "加群了解")![](img/aab6c923225b0a35b6580de17534641d.jpg)

注： 有想了解**愿码全思维 IT 工程师加速器**的朋友，可以扫码加群咨询。

* * *

### **changelog**

2019-03-04 zhangliang

*   初次发稿