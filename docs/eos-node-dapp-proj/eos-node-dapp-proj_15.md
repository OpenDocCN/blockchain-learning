# 6.6 帐户资金管理设计与实现

# 资金管理功能设计与实现

本小节主要讲解在交易所中如何实现对用户资金的数据管理。当用户进行不同币种的充值或者提现操作时，如何维护对应数据信息、数据结构应该如何设计以及在开发过程可能会遇到哪些安全问题。

## 功能介绍

资金功能：主要用来管理交易所用户在充值与提现过程对其帐户数据的实时更新。

示例： 当用户 A 进行 EOS 充值时，交易所应及时更新用户的 EOS 总金额；当用户 B 进行 DICE 提现时，交易所需要判断其提现金额是否超出其可用金额，因为当用户进行下单时会锁定用户资金，这样用户可导出的资金金额为总金额减去冻结金额。

## 数据结构

| 字段 | 数据类型 | 说明 |
| --- | --- | --- |
| 总金额 | eosio: :asset | 帐户总金额 |
| 冻结金额 | eosio: :asset | 比如：刚创建订单时需要冻结对应订单余额。 |

注：在实际开发时，可以考虑按照用户维度进行帐户资金隔离；也可以将所有用户的币种金额按一个维度进行存储。

## 约束条件

*   仅限合约管理员操作
*   充值时时需要币种对应合约触发 transfer 事件来进行充值；
*   交易所不允许给自己充值
*   充值时接收地址必须为交易所本身
*   转帐金额必须大于 0
*   交易所锁定状态时无法进行充值与提现
*   充值或提现币种必须存在
*   提现金额必须小于等于可用金额（总金额-冻结金额）

## 安全问题

*   权限验证
*   方法分级授权
    可根据管理角色进行细粒度方法权限授权，确保关键业务由高级别管理员控制。比如：对于资金的提现功能只允许最高级别管理员操作；而合约的基础数据操作可交由运维管理员进行操作。
*   由 transfer 事件触发的币种充值，需要验证币种对应的合约为合法合约。例如：充值 EOS 则需要验证 transfer 消息是来自 eosio.token 合约。

## 涉及命令知识点

*   查看 Docker 服务

    ```js
    docker ps
    ```

*   进入 Docker 命令窗口

    ```js
     docker exec -it <container name> /bin/bash
    ```

*   解锁钱包

    ```js
    cleos wallet unlock -n <钱包名称> --password <钱包密码>

    # 例如: 打开名称为 hackdappexch 的钱包
    cleos wallet unlock -n hackdappexch --password $(cat hackdappexch_wallet_password.txt);
    ```

*   发布合约

    ```js
    cleos set contract <合约名> <合约目录> -p <合约名>@active
    ```

*   调用合约方法

    ```js
    cleos push action <合约名> <合约方法> [<参数 1>,<参数 2>] -p <合约名>@active
    ```

*   查询数据表

    ```js
    cleos get table <合约名> <scope> <表定义>
    # scope 值取决于实例化索引时所传入的值, 一般实例化索引时传入 _self,即合约本身。
    ```

    * * *

通过本章节的学习、思考以及动手实践， 我们完成了对用户资金的充值、提现功能。

* * *

> 在教程中如出现错误🐛或不易理解的知识点，欢迎加我微信指正! Name: zhangliang | WeChat: rushking2009 | Mail: zhangliang@cldy.org

* * *

**changelog** 2019-03-01 zhangliang \zhangliang@cldy.org\

*   初次发稿