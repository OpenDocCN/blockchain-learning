# 11.10 å¦‚ä½•æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„ï¼ˆDeferred Actionã€Inline Actionï¼‰

EOS æ™ºèƒ½åˆçº¦ä¸­æ”¯æŒä¸¤ç§ Action è¿›è¡Œåˆçº¦é—´æ–¹æ³•è°ƒç”¨ã€‚**Inline actions**å¯ç†è§£ä¸ºåŒæ­¥æ‰§è¡Œæ“ä½œï¼›**Deferred actions**ä¸ºå¼‚æ­¥æ‰§è¡Œæ“ä½œã€‚

**Inline actions**ï¼Œå¼ºè°ƒåœ¨åŒä¸€äº‹åŠ¡ä¸­çš„å…³è”æ–¹æ³•æ‹¥æœ‰ä¸è°ƒç”¨å…¥å£æ–¹æ³•ç›¸åŒçš„æƒé™ã€‚å®ƒä»¬å¯ä»¥ä¿è¯å½“å‰å…³è”æ–¹æ³•ä¸­çš„ä»»ä½•ä¸€ä¸ªæ–¹æ³•å‡ºç°é”™è¯¯ï¼Œéƒ½ä¼šå›æ»šæ•´ä¸ªäº¤æ˜“æ•°æ®ã€‚å¦å¤–ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ä¸€ä¸ªäº¤æ˜“ä¸­çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯åœ¨åŒä¸€ä¸ªåŒºå—ä¸­æ‰§è¡Œçš„ã€‚

**Deferred actions**ï¼Œæ˜¯åˆçº¦è®¾å®šä¸ºå°†æ¥æŸä¸€ä¸ªæ—¶åˆ»è¿›è¡Œæ‰§è¡Œçš„æ–¹æ³•ã€‚å®ƒä¸**Inline actions**ä¸åŒä¹‹å¤„åœ¨äºï¼šå®ƒä¸èƒ½ä¿è¯è¢«æ‰§è¡Œã€‚å› ä¸ºåˆçº¦æ–¹æ³•å†…è¿›è¡Œ**Deferred action**è°ƒç”¨æ—¶ï¼Œä¹Ÿå°±æ„å‘³ç€æ–°å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ã€‚è€Œè¿™ä¸ªäº‹åŠ¡æœ€ç»ˆèƒ½å¦è¢«ç”Ÿäº§èŠ‚ç‚¹æ‰€æ¥å—å…¶å®å¹¶ä¸èƒ½ç¡®å®šã€‚ä½†å³ä½¿æ˜¯å¤±è´¥ï¼Œ**Deferred action**ä¹Ÿå¹¶ä¸ä¼šå¯¹æºæ–¹æ³•é€ æˆæ•°æ®å›æ»šå½±å“ï¼Œå› ä¸ºå½“å»¶è¿Ÿæ–¹æ³•å¼€å§‹æ‰§è¡Œæ—¶ï¼Œå¯èƒ½æºæ–¹æ³•æ‰€åœ¨åŒºå—å·²ç»è¢«ç”Ÿäº§å‡ºæ¥äº†ã€‚

å¯èƒ½æœ‰äººä¼šé—®ï¼Œæ—¢ç„¶**Deferred actions**ä¸èƒ½ç¡®å®šæ˜¯å¦è¢«æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆå®ƒè¿˜æœ‰å­˜åœ¨çš„æ„ä¹‰å—ï¼Ÿ

å…¶å®ï¼Œ**Deferred actions**åœ¨å®é™…å¼€å‘åœºæ™¯ä¸­ï¼Œç¡®å®æ˜¯æœ‰å…¶å­˜åœ¨çš„æ„ä¹‰ã€‚åªä¸è¿‡éœ€è¦ç»“åˆä¸åŒä¸šåŠ¡åœºæ™¯ä½¿ç”¨ï¼Œä¸å¦¨æƒ³ä¸€æƒ³ï¼Œæˆ‘ä»¬ä¸€ä¸ªåˆçº¦æ–¹æ³•ä¸­å¯èƒ½ä¸šåŠ¡é€»è¾‘ç¨å¾®å¤æ‚ä¸€äº›ï¼Œè€Œ EOS é“¾åˆè¦æ±‚æ‰€æœ‰çš„åˆçº¦æ–¹æ³•æ‰§è¡Œæ—¶é—´ä¸å¯è¶…è¿‡ 30msï¼Œé‚£å¾ˆå¯èƒ½å¤æ‚çš„æ–¹æ³•å°±æ— æ³•æ‰§è¡Œäº†ã€‚ä½†å¦‚æœè¿™æ—¶ï¼Œä½ å°†ä¸€äº›éå¼ºäº‹åŠ¡å‹çš„æ–¹æ³•ï¼Œè¿›è¡ŒæŠ½å–æ”¹ä¸ºå¼‚æ­¥æ‰§è¡Œï¼Œè¿™æ ·å°±ä¼˜åŒ–æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ç¡®ä¿åˆçº¦æ–¹æ³•çš„æ­£å¸¸æ‰§è¡Œã€‚

é‚£ä¹ˆï¼Œå“ªäº›æƒ…å†µæ˜¯å±äºéå¼ºäº‹åŠ¡å‹çš„æ–¹æ³•å‘¢ï¼Ÿ

æ¯”å¦‚ï¼šæ—¥å¿—è®°å½•ï¼Œå¯é‡å¤æ‰§è¡Œçš„æ–¹æ³•ï¼ˆå³å¼‚æ­¥æ‰§è¡Œå‡ºé”™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰‹åŠ¨è°ƒç”¨æ¥å¼¥è¡¥é”™è¯¯ï¼‰ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ç¤ºä¾‹ä»£ç çš„å½¢å¼ï¼Œè®©å¤§å®¶ç†è§£æ•´ä¸ªè¿‡ç¨‹ï¼š

* * *

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„åˆçº¦, å®šä¹‰ä¸¤ä¸ªæ–¹æ³•`sendÂ `ã€`deferredÂ `ã€‚åœ¨`sendÂ `æ–¹æ³•ä¸­å‘èµ·å¯¹`deferredÂ `æ–¹æ³•çš„å»¶è¿Ÿè°ƒç”¨

```js
void dexchange::deferred(name from, const std::string &message){
    require_auth(from);
    print("Printing deferred ", from, message);
}

void dexchange::send(name from, const std::string &message, uint64_t delay){
    require_auth(from);

    eosio::transaction t{};
    t.actions.emplace_back(
        action(
            eosio::permission_level(from, "active"_n),
            _self,
            "deferred"_n,
            std::make_tuple(from, message)
        )
    );

    t.delay_sec = delay;
    t.send(now(), from);

    print("Scheduled with a delay of ", delay);
}
```

ç„¶åï¼Œå†å®šä¹‰ä¸€ä¸ª`onErrorÂ `æ–¹æ³•ï¼Œå½“ EOS é“¾å‘ç°å»¶è¿Ÿæ–¹æ³•æ‰§è¡Œå¤±è´¥æ—¶ï¼Œ ä¼šç”±ç³»ç»Ÿè§¦å‘åˆçº¦ä¸­çš„`onErrorÂ `æ–¹æ³•ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯

```js
void onError(const onerror &error){
    print("Resending Transaction: ", error.sender_id);
    transaction dtrx = error.unpack_sent_trx();
    dtrx.delay_sec = 3;
    dtrx.send(now(), _self);
}
```

ä¸‹ä¸€æ­¥ã€å®šä¹‰å®å®šä¹‰ï¼Œæ ¹æ®ç³»ç»Ÿé€šçŸ¥æ¥å†³å®šå¦‚ä½•è·¯ç”±è¯·æ±‚ã€‚

```js
extern "C" { 
  void apply(uint64_t receiver, uint64_t code, uint64_t action){
    if (code == "eosio"_n.value && action == "onerror"_n.value){
        eosio::execute_action(eosio::name(receiver), eosio::name(code), &dexchange::onError);
    }

   if (code != receiver)
      return;

    switch (action) {
         EOSIO_DISPATCH_HELPER(dexchange, (send)(deferred));
    };
    eosio_exit(0);
  }
}
```

ä¸Šé¢è¿™ä¸ªä»£ç ç¤ºä¾‹ä¸­ï¼Œapply æ–¹æ³•å¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªå‚æ•°: receiverã€codeã€action. receiver å‚æ•°å°±æ˜¯æˆ‘ä»¬åˆçº¦çš„å¸æˆ·åï¼› code çš„æ˜¯è¦å–å†³äºåˆçº¦æ–¹æ³•è°ƒç”¨æ–¹ï¼Œå‡å¦‚æ˜¯åˆçº¦è°ƒç”¨è‡ªå·±å†…éƒ¨çš„æ–¹æ³•ï¼Œé‚£ä¹ˆ code ä¸ receiver ä¸€è‡´ï¼Œå‡å¦‚æ˜¯å…¶ä»–åˆçº¦è°ƒç”¨æœ¬åˆçº¦çš„æ–¹æ³•ï¼Œåˆ™ code ä¸ºå…¶ä»–åˆçº¦çš„å¸æˆ·åï¼›è‡³äº action ä¾¿æ˜¯è°ƒç”¨çš„æ–¹æ³•åç§°ã€‚

åœ¨è¿™é‡Œä¹‹æ‰€ä»¥ä½¿ç”¨å®å®šä¹‰ï¼Œå°±æ˜¯å› ä¸ºåœ¨å®é™…çš„å¼€å‘åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦åˆ¤æ–­ code æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯åˆæ³•çš„åˆçº¦å¸æˆ·å‘é€è¿‡æ¥çš„è¯·æ±‚ã€‚æ¯”å¦‚ï¼šè¿›è¡Œäº¤æ˜“æ‰€ EOS èµ„é‡‘å……å€¼æ—¶ï¼Œå¾€å¾€äº¤æ˜“åˆçº¦æ˜¯æ ¹æ®æ”¶åˆ° eosio.token çš„ transfer æ¶ˆæ¯é€šçŸ¥æ—¶æ‰ä¼šè¿›è¡Œäº¤æ˜“æ‰€èµ„é‡‘çš„ä¿®æ”¹ï¼Œå¦‚æœä¸åœ¨å®å®šä¹‰å¤„é€šè¿‡ code åˆ¤æ–­æ¶ˆæ¯æ¥æºï¼Œé‚£å¾ˆå¯èƒ½å°±ä¼šé€ æˆå‡å……å€¼ã€‚

æœ€åï¼Œå‘å¸ƒæ™ºèƒ½åˆçº¦ï¼Œè°ƒç”¨`sendÂ `åˆçº¦æ–¹æ³•æ¥è¿›è¡Œæµ‹è¯•ã€‚å¦å¤–ï¼Œå»¶è¿Ÿæ–¹æ³•åœ¨æ²¡æœ‰æ‰§è¡Œä¹‹å‰ï¼Œå…¶å®æ˜¯å¯ä»¥é€šè¿‡`cancel_deferredÂ `æ–¹æ³•è¿›è¡Œäº¤æ˜“å–æ¶ˆçš„ã€‚

* * *

**å°ç»“**

é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ ï¼Œæˆ‘ä»¬äº†è§£åˆ°`deferredÂ `ä¸`inlineÂ `æ–¹æ³•é—´çš„å·®å¼‚æ€§ä»¥åŠå¦‚ä½•æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©ä¸åŒçš„æ–¹æ³•è¿›è¡Œä»£ç å®ç°ã€‚

* * *

> åœ¨æ•™ç¨‹ä¸­å¦‚å‡ºç°é”™è¯¯ğŸ›æˆ–ä¸æ˜“ç†è§£çš„çŸ¥è¯†ç‚¹ï¼Œæ¬¢è¿åŠ æˆ‘å¾®ä¿¡æŒ‡æ­£! Name: zhangliang | WeChat: rushking2009 | Mail: zhangliang@cldy.org

![Show me your code.](img/9c507c40d372f5692d061c802a44deb2.jpg "åŠ ç¾¤äº†è§£")![](img/aab6c923225b0a35b6580de17534641d.jpg)

æ³¨ï¼š æœ‰æƒ³äº†è§£**æ„¿ç å…¨æ€ç»´ IT å·¥ç¨‹å¸ˆåŠ é€Ÿå™¨**çš„æœ‹å‹ï¼Œå¯ä»¥æ‰«ç åŠ ç¾¤å’¨è¯¢ã€‚

* * *

### **changelog**

2019-03-13 zhangliang(mailto:zhangliang@cldy.org)

*   åˆæ¬¡å‘å¸ƒ