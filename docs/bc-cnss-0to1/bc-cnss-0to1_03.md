# 第三章 POW-目标值

很多文章或解析将区块里的 Bits 字段解读成难度值，其实是错误的。Bits 的作用是直接和区块头 2 次 sha256（）的结果进行比较大小的。比较之前，需要先将两者的类型转换成 big.Int 型。起初 Bits 类型是 Uint32；hash 类型是字节数组。

## 目标值的产生

目标值是怎么产生的呢？
目标值是一个变量，中本聪设的初始值是 0x1d00ffff。这个目标值以后会每隔 2016 个区块，根据过去 2016 个区块花费时长算出的难度值进行调整，保证正常出块的时间在 10 分钟左右。所有节点都会按统一公式自动调整 Bits，调整公式：

新难度值=旧难度值*（过去 2016 个区块花费时长（分）/20160 分钟）

目标值=最大目标值/难度值。

最大目标值是恒定的，即为创始区块的 Bits 值`0x1d00FFFF`。这个数的由来是`0x00000000FFFF0000000000000000000000000000000000000000000000000000`这个 64 位 16 进制数通过小端法存储得来。这个 64 位数字存储需要占 32 个字节，而 Bits 在区块头占大小是 4 个字节，所以通过小端法存储可以把后边的 0 都抹去，最后得到的数占 4 个字节。小端法英文表示 little-endian，一种是将低序字节存储在起始地址的存储方法。我们经常用到的存储都是大端法，按数据字节顺序从高到低存储。

`0x00000000FFFF0000000000000000000000000000000000000000000000000000`来自中本聪定义的数字`0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF`使用浮点编码类型得来的。方法是为满足实现小端法存储，中本聪处理后面 F 的方法，具体不作分析。真正在代码中出现的最大目标值只是`0x1d00FFFF`，也就是创始区块的 Bits。

每 2016 个区块完成后，会自动调整新的目标值 Bits。从上边公式可以看出新 Bits 与难度值成反比。因为 Bits 是小端法存储，所以存储的数据越大说明实际的数字越小，那么挖矿越难；反之越简单。难度值也是个变量，最开始前 2016 个块数值是 1，之后每隔 2016 个块后都会改变。在矿工挖矿过程中，都会有一个计时器，记录每个区块挖矿的时间，当累加 2016 次后，将会通过新难度值公式，计算出下一次挖矿的难度值，然后再通过目标值公式得到以后挖矿的目标值。

## 还原真实目标值

在矿工挖矿过程中，产生的 hash 值与目标值进行比较大小，需要将目标值还原成真实值。目标值由指数（exponent）和系数（coefficient）两部分组成。高位一个字节为指数，低位三个字节为系数。真实目标值用 target 表示。

真实的目标值的大小计算方式是：target = coefficient *2^(8* (exponent – 3))

比如：
在区块 277,316 中，nBits 字段的值为 0x1903a30c，则 0x19 为指数，而 0x03a30c 为系数。
计算难度目标的公式为：
target = coefficient *2^(8* (exponent – 3))

由此公式，以及难度位 nBits 的值 0x1903a30c，可得：

target = 0x03a30c *2^(0x08* (0x19 - 0x03))^

=> `target = 0x03a30c * 2^(0x08 * 0x16)^`
=>`target = 0x03a30c * 2⁰xB0^`

按十进制计算为：

=>`target = 238,348 * 2¹⁷⁶^`
=> `target = 22,829,202,948,393,929,850,749,706,076,701,368,331,072,452,018,388,575,715,328`

转化回十六进制后为：

=> `target = 0x0000000000000003A30C00000000000000000000000000000000000000000000`

​也就是说高度为 277,316 的有效区块的区块头哈希值是小于这个真实目标值的。这个数字的二进制表示中必须超过 60 位的前导位都是 0。在这个级别的难度，一个每秒可以处理 1 万亿次（1 tera-hash per second 或 1 TH/sec）哈希计算的矿工平均每 8,496 个区块，或者平均每 59 天，才能找到一个正确结果。

再看下比特币中创世区块(GenesisBlock)的难度值：
nBits 字段值为：0x1d00ffff(十进制即为：486604799)，表示为十六进制的 Target 值为：`00000000ffff0000000000000000000000000000000000000000000000000000`

综上，这个高度为 277,316 的有效区块的区块头的部分信息如下：

```go
 A：Bits = "0x1903a30c"

 B：exponent 指数，exponent = 0x19

 C：coefficient 系数，coefficient = 0x03a30c

 D：target = coefficient * Math.Pow(2, 8 * (exponent - 3))

 E：Bits 真实值（target）：0x0000000000000003A30C00000000000000000000000000000000000000000000

 F：本区块 hash：00000000000000000041ff1cfc5f15f929c1a45d262f88e4db83680d90658c0c 
```