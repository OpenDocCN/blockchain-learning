# 第七章 POW+POS 混合共识算法

上一章节说过，实际运用 pos 是需要借助其他算法才能实现的。本章节主要学习点点币的共识算法，该算法是基于 POW 改进的 POS 算法。

## 混合共识算法的定义

现在很多公链都是在用基于 xx 和 xx 算法的混合共识算法实现共识机制的。什么是混合共识算法呢？
有两种情况都可以认为是混合机制：
1.在某个算法的基础上，运用其他算法的技术进行改进。如点点币，它的共识机制是用 pos 算法对 pow 算法进行改进后的机制，不过大家往往认为点点币的共识机制是 pos，其实严格来说是 pow+pos 的。
2.两个算法运算相互独立，但共同组成了一个共识机制。如初链，它的共识是 pow 和 pbft 两个算法组成的，然后自己给自己起了个新名字叫混合共识机制 fpow。这种混合很明显，所以大家都会叫混合机制。

## 混合共识机制 POW+POS

点点币是第一个基于 POS 发行的数字货币，所以接下来我将带大家深入学习它的共识算法，加深对 POS 的理解。

与 PoW 一样，为了抢到将区块写入区块链的权利，节点同样要进行 hash 计算，只不过最终的解和币龄有关，计算公式：
proofHash < coinAge * target；

```go
coinAge 是币龄，target 是一个目标值，用于调整难度。coinAge * target 的值越大，难度就越小，抢到区块的概率就越高。 
```

假如你的钱包里是 0 个币，那么你的币龄就是 0, 计算一个小于 0 的 hash 值根本不可能，因此基本上抢不到区块。
点点币的出块时间也是 10 分钟左右一个。币龄之前讲过，就是持币数*持币时间；proofHash 也就是 pow 的挖矿函数，即两次 sha256 hash 运算。所以重点我们要学习 target 的值是怎么实现的，怎么调整使出块时间在 10 分钟左右呢？

## 点点币的目标值

点点币难度值是一个一直动态调整的，每隔 2 个区块就调整一次难度（目标值），使出块时间维持在 10 分钟左右。
点点币使用目标值来衡量挖矿难度，目标值与难度成反比，目标值越大、难度越小；反之亦然。当前区块的目标值与前一个区块目标值、前两个区块的时间间隔有关。
计算公式如下：

　`当前区块目标值 = 前一个区块目标值 * (1007 * 10 * 60 + 2 * 前两个区块时间间隔) / (1009 * 10 * 60)`
由公式可见，两个区块目标间隔时间即为 10 分钟。
如果前两个区块时间间隔大于 10 分钟，目标值会提高，即当前区块难度会降低。
反之，如果前两个区块时间间隔小于 10 分钟，目标值会降低，即当前区块难度会提高。
点点币的挖矿难度值=创始区块目标值/当前区块目标值。网页中显示的当前块难度值就是这样算出来的。

挖矿过程和 pow 一样，需要比较 hash 值与目标值大小，广播区块，验证区块，上链等等。