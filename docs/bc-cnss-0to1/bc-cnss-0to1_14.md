# 第十四章 EOS 共识机制

EOS 在第一版白皮书中使用的 DPOS 共识机制，而在新一版的白书中，对共识机制进行了改进，使用 BFT+DPOS 混合共识机制。使出块速度从原来的 3 秒变为 0.5 秒，tps 显著提高，达到测试 3590 次/秒。

## EOS 第一版共识机制 DPOS

EOS 现在系统运行的链用的共识机制是第一版白皮书的，也就是纯 DPOS 共识机制。
DPOS 即授权权益证明共识机制。相比于比特币的 POW 机制，DPOS 不用浪费算力资源去争夺记账权，而是通过赋予 EOS 通证持有人的投票选举，选出 21 个超级节点担任记账人的角色，保证整个网络的正常运行。值得一提的是，人们的投票所占的比重取决于他们持有多少 token。这意味着拥有更多 token 的人将比拥有极少 token 的人更多地影响网络。这其实很好理解，因为持有网络的运行的好坏会对持有更多 token 的人的利益产生更大的影响，这使得他们的投票更谨慎。
21 个超级节点轮流负责记账。每轮都会随机打乱他们的出块顺序，每个超级节点作为出块节点时，只负责出一个块。每一个区块产生后会按照顺序传递给下一个超级节点中。第二个超级节点要负责打包新的区块，同时还要确认上一个区块的内容。当某一个区块被超过 2/3 的超级节点确认后，则该区块将成为不可逆转区块，即上链区块。

该算法有些地方明显需要改良。比如容易出现漏块现象。21 个超级节点分布世界各地，如果随机打乱顺序，导致总是依次顺序的节点相距地理位置很远，如中国和美国，这两国的网络传输单向时间是 300 毫秒，一来一回总共 600 毫秒。那么中国这边出块，然后经过其他 20 个节点确认后返回，假设时间总共是 4 秒；而接下来美国出块，反馈回来的时间是 3 秒，比中国快 1 秒，肯定是先上链的，结果中国出的块就被丢弃掉了。当前目前设的出块时间是 3 秒，理论上能够解决这种漏块现象，但想提高 eos 的性能，这块肯定是要改进的。

## EOS 最新版共识机制 BFT-DPOS

BFT 即拜占庭容错算法。EOS 引入这个算法，主要是赋予出块节点更大的权力，加快出块速度，解决节点出的块都被漏掉的问题。

EOS 共识算法的升级，势必需要超级节点们更新代码，使用新的程序，然后在当前链上继续运行。但如果超过 1/3 的节点拒绝更新代码，可能会出现硬分叉问题。所以如何很好地做好过渡是 EOS 最大难题。

我们一起分析下改进后的共识机制是如何工作的。

EOS 使用 BFT+DPOS 共识机制后，不再按照出块顺序让超级节点一个个验证区块内容，而是让出块节点成为主节点。出块后，同时向其他 20 个超级节点进行广播该区块，并获得他们的验证。如果超过 2/3 的节点验证通过后，则该区块将成为不可逆转区块。

BFT 可以使 EOS 出块速度显著增加。目前使用 BFT+DPOS 共识机制的 EOS，可以实现 0.5 秒的出块速度，1 秒实现区块的不可逆转。为避免因出块速度过快而漏块，EOS 的超级节点按照其他的地理位置依次轮流成为主节点，尽可能减少超级节点的网络延迟。比如超级节点有中国、美国、加拿大、日本，那么成为主节点的顺序是中国>日本>美国>加拿大或者反过来，总之保证相邻最近的超级节点要依次交接主节点角色。

同时规定每个主节点连续生产 6 个区块，至少保证 6 个区块的前几个能确认完成，不存在整个超级节点被跳过的现象。可以看出每轮记账节点的出块总时间还是 3 秒钟，在这 3 秒里，因为他对他自己出的块是信任的，所以可以持续出块。一边出块一边广播，3 秒之内率先广播的区块肯定能够得到确认，在网络通畅的情况下，6 个区块都会可能得到确认。

EOS 共识处理分叉问题非常简单，和比特币一样，节点只会认可最长的链作为合法链。假如某个节点开始作恶，自己出块并生成自己的链，也就是每次轮到它就产生 6 个块。但是超级节点总共 21 个，每轮产生理论 126 个块。根据选择最长链作为主链原则，肯定作恶的链得不到认可。所以 EOS 不会发生分叉问题。